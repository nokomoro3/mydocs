# SAA

---
## storage

### S3

- 冗長化
  - デフォルトでAZ冗長構成となっている。
  - さらに冗長構成を高めるためには、クロスリージョンレプリケーションを使用する。
    - 使用するためにはバージョニングが有効である必要がある。

- 高速化
  - 処理並列化の工夫として日付やタイプ別のprefixを付与し、prefix毎に並列化することが可能。
  - グローバルなサービスで長距離にわたって高速転送をする場合は、Transfer Accelerationを使用する。

- オンプレとの連携
  - ストレージゲートウェイを使用する。
  - 標準的なプロトコル(NFS, SMB, iSCSI)を使用可能。
  - ２つのタイプがある。
  - 保管型ボリューム
    - プライマリをローカル、AWSに非同期にバックアップ可能。
    - データは、EBSスナップショットとしてS3にバックアップされる。
  - キャッシュ型ボリューム
    - プライマリをS3として使用し、アクセスするデータをローカルに保持する。

- エンドユーザーへの一時アクセス許可
  - 事前署名付きURLを使用可能。

- ストレージクラス
  - Standard
    - 標準
  - Standard IA
    - 低頻度アクセス用
  - One-zone IA
    - 重要でなく、低頻度アクセス用
  - RRS
    - より耐障害性が低く、Standardよりも高いため、非推奨方式
  - Glacier
    - 長期保存用。
    - 最低保持期間が90日のため、それ以下で不要になる場合は他のクラスが選択肢となる。
    - 迅速読み取りも可能だが、数分のアクセス時間は必要。
    - 通常は、3～5時間で読み取り
    - 大容量取り出しは5～12時間で読み取り。
  - Glacier Deep Archite
    - ～12時間で読み取り。

- 整合性
  - 2020年12月より、強い整合性モデルに変更されている。

- MFA認証
  - 誤って削除するのを防ぐ目的で、削除時にMFA認証を設定することができる。

#### バージョニング

- バージョニング可能なのはS3のみ。(EBSやEFSはバージョニングできない)

#### ライフサイクル管理

- 一定期間後のクラス変更や削除など様々なライフサイクルポリシーを設定可能。
- EBSはライフサイクル設定できず、EFSはIAに移動させる管理しか対応できない。
- Glacierも一番最初の保存先選択した場合は、一定期間後に削除するポリシーなどを設定はできない。

### EBS

- EBSの種類
  - 汎用SSD
    - 通常用途。アプリケーションなどの環境用。
    - スループットについてはスループット最適化HDDより低い場合があるため注意が必要。
      - スループットは、gp3は1,000[MiB/sec]でgp2は250[MiB/sec]
      - IOPSはSSDの方が総じて良い。
  - Provisioned IOPS SSD
    - IOPSが16,000必要な高パフォーマンス用。
    - マルチアタッチも可能。
  - スループット最適化HDD
    - 500 MiB/sec程度の高スループット。
    - IOPSはSSDよりも低い。
    - ルートボリュームには設定不可。
  - コールドHDD
    - アクセス頻度の低い用途。
    - 250 MiB/sec程度のスループット。
    - ルートボリュームには設定不可。

- EBSの冗長化
  - ミラーリング(RAID1)は最も、回復性が高い。
  - その他には、スナップショットやAMIの作成があるが、回復性は低い。

- EBSのリージョン移動
  - EBS自体を移動することはできないため、スナップショットを作成し、別リージョンで複製する必要がある。

- マルチアタッチ
  - プロビジョンドIOPSのみマルチアタッチが可能。

### EFS

- 接続方法
  - AZ毎に１つのマウントターゲットが必要
  - NFSv4を使用

- ライフサイクル管理
  - 自動的なファイルストレージ管理
  - 30日アクセスされなかったファイルをEFS IAクラスに移行する。
  - データ削除などのライフサイクル管理設定はできない。

- S3との比較
  - S3と異なりインターネットからの直接アクセスは不可能
  - EFSは強い整合性やファイルのロックなどが可能であり、S3には結果整合性しかない。

### Snowball

- Snowball edge
  - 安全なデバイスを使用し、ペタバイト規模の大容量データを転送するサービス。
  - 物理的なハードウェアを用いた移転が可能。

### 高機能なストレージのIOPS比較

- EBSのプロビジョンドIOPSは、最大64,000IOPSのベースラインまで。
- EFSは、500,000超のIOPSまで。
- Amazon FSx for Windowsは、数百万IOPSまで対応。
- Amazon FSx for Lustreは、スーパーコンピューター用。

---
## streaming

- Kinesis Streamのデータ保持期間
  - 保持期間のデフォルトは24時間。設定によっては365日まで変更可能。

- データに対する分析タスク
  - KCL(Kinesis Client Library)で実施可能。
  - Kinesisアプリケーションは、複数のインスタンスを持つことができ、KCLワーカーが各インスタンスに対応する処理ユニットです。
  - レコードプロセッサはKinesis Data Streamsのシャードからデータを処理するユニットです。
  - 1つのレコードプロセッサは1つのシャードに対応し、複数のレコードプロセッサがKCLワーカーにマッピングされます。

---
## Database

### DynamoDB

- マルチAZ構成は不可。
- Read/Write双方ともAuto Scalingの設定に対応。
- 登録・変更などをトリガにlambda実行などをする場合は、DynamoDB Streamを有効化する。
  - この変更情報は最大24時間保存される。
  - Streamを使わずに、LambdaとCloudWatch Eventsを連携することでも構築可能。

### RDS

- マルチAZ構成は可能。
  - 目的は冗長化。これによりセカンダリーDBを別AZに構築し、フェイルオーバー構成が可能。

- 暗号化は、作成時に有効化可能。

- Auto Scalingはストレージ容量のみに対応。

- lambdaと接続する場合は、RDS Proxyによりconnection poolを使って接続する。
  - これにより、同時接続数の制限に達しないようにすることが可能。
  - ファイルオーバーに対する耐障害性もあり、スタンバイ側に再接続が可能。
  - https://blog.serverworks.co.jp/2022/01/20/093110

- リードレプリカを利用したフェイルオーバーは不可。
  - Auroraではこれが可能。

- リードレプリカはデータにラグが発生する可能性がある。
  - 非同期にレプリケートされる別インスタンスであるため
  - 最新のトランザクションのいくつかを表示できない可能性がある。

### Aurora

- 高速な回復性
  - リードレプリカ別リージョンに構成すれば、リージョン障害時でも使用することが可能。

- RDSとの比較
  - 一日のトランザクション数が10,000を超えるなどのケースはAuroraを選択する。

### Redshift

- マルチAZ構成は不可。

- スポットインスタンスは使用不可。
  - オンデマンドおよびリザーブドのみ使用可能。

- クロスリージョンスナップショット
  - 障害時、クラスタの復旧に備えるために使用。
  - S3に自動的にスナップショットが保存されるようになる。

- 拡張VPCルーティング
  - これを有効にすると、通常のVPCと同様以下の設定が可能になります。
    - セキュリティグループ, ACL, VPCエンドポイント
  - 設定による料金は発生しません。
  - 逆に設定しない場合は、その他のAWSサービスなどへのトラフィックが、インターネット経由でルーティングされます。

---
## Data Analytics

### EMR

- 動的なスケーリングが可能
- データ集約型のタスクに有用
  - ログ解析
  - データマイニング
  - 科学シミュレーション

---
## Network

### インターネット接続要件

- パブリックサブネットの場合、IGWがサブネットのルートテーブル設定されている。
- プライベートサブネットの場合、NATGWがサブネットのルートテーブル設定されている。
- NATGWがパブリックサブネットに設置されている。
- セキュリティグループの設定でインターネットアクセス許可がされている。(IGWもしくはNATGWに対して)
- ACL設定でインターネットが拒否されていない。
- パブリックIPアドレスが付与されている。(自動割り当てが有効化されている。)

### VPC

- VPC間接続にはVPC Peeringを使用する。
  - これは別のAWSアカウント間でも接続可能

- VPC Peeringで複雑になる場合は、Transit Gatewayを利用する。
  - これによりハブ・アンド・スポークス構成を使用できる。

- 設定可能なCIDR範囲は`/16 ～ /28`である。

- サイト間VPN
  - オンプレと接続する場合、それぞれに以下が必要。
    - カスタマーゲートウェイ(オンプレ側の接続点)
    - 仮想プライベートゲートウェイ(AWS VPC側の接続点)
  - VPNへの接続は、Client VPN Endpointから行う。

- VPC内のインスタンスにDNS名を取得するためには、DNSホスト名有効化オプションが必要。

### ACL

- アウトバンド・インバウンドの設定
  - `Egress:true`でアウト、`Egress:false`でインとなる。
- ポート設定
  - HTTPは`80`、FTPは`20`などとなる。
- 特定のIPアドレスの攻撃からサブネットを保護するFirewallとしても使用可能。

### Route53

- ルーティングの種類
  - シンプルルーティング
  - 加重ルーティング
    - 複数エンドポイント毎の重みによりDNSクエリに応答。Blue/Greenデプロイメントに使用。
  - フェイルオーバールーティング
    - ヘルスチェックの結果に基づき、プライマリ・セカンダリを切り替える。高可用性が目的。
  - 複数値回答ルーティング
    - ランダムに選ばれた最大8つの別々のレコードを使用して複数の値を返答する。
    - ヘルスチェックを実施したり、ELBのようにDNSを使用した負荷分散が可能
  - レイテンシールーティング
    - レイテンシが小さいリージョンへルーティングする。
  - 位置情報ルーティング
    - ユーザーのIPアドレスにより位置情報を特定し、地域毎に異なるレコードを返す。
  - 地理的近接性ルーティング
    - ユーザーとリソース双方の場所に基づいて近接性ルールを作成してルーティングする。
    - AWSリソースを使用している場合はリソースのリージョン、それ以外の場合はリソースの緯度と経度に基づく。
    - 特殊なルーティングであり、トラフィックフローを利用して設定が必要。

### CloudFront

- コンテンツを高速配信するためのCDNサービス。

- 画像等の取得リクエストに対して応答性を挙げるために使用。

- キャッシュ保持期間はTTL(Time To Live)で設定
  - TTLのデフォルトは1日。0秒～1年で指定可能。

- コンテンツ圧縮を有効化することで、高速化やデータ削減(コスト削減)が可能。
  - ただし、Viewer（ブラウザ等）で`Accept-Encoding: gzip`が有効である必要がある。

- 地理的ブロッキングで、特定地域のユーザーのアクセスを回避可能。

- S3へのアクセス制限(IP制限等)するためにも使用される。
  - CloudFrontのOAIを使い、特定のdistributionのみをS3のBucket Policyで許可
  - CloudFrontにWAF ACLを設定し、特定のIPアドレスのみを許可

---
## Ops

### Beanstalk

- 自動的にデプロイ・スケーリングを行うサービス。
  - キャパシティのプロビジョニング
  - 負荷分散
  - Auto Scaling
  - ヘルスチェック
- ユースケースとしては以下
  - Webアプリケーション
  - ワーカー環境
    - ただしBatch処理などは対象外。

### OpsWorks

- ChefやPuppetが使用可能。
- 複雑なインフラストラクチャ管理や設定を行うサービス。
- スタックベースやレイヤーなどの構築の用途の場合はCloudFormationではなくこちらを使用する。

### CloudFormation

- 必須要素はResources。
- Properties, Outputs, Description, Metadataはオプショナル。

### CloudWatch

- CloudWatch Logs
  - EC2, CloudTrail, Route53などのログファイルを監視することが可能
  - エラー率が閾値を超えた場合に、管理者に通知を送るなどが可能。

- CloudWatch Events
  - システムイベントを監視し、ルールに一致したイベントを一つ以上の関数やストリームに振り分けられる。
  - cron式やrate式により、特定の時間にトリガしたり、スケジュールが可能。
---
## IAM

### 権限

#### 本番・開発の分離

- 開発者には開発者用アカウントを付与する。
- インスタンス等にタグを設定し、操作許可を限定する設定も有用。

---
## Computing

### EC2

- ユーザーデータ
  - 起動時に実行したいコマンドを記述することができる。

- 起動設定と起動テンプレート
  - 起動設定は、AMIが変更されると再作成が必要、バージョン管理が不可など機能が少ない。
  - 起動テンプレートはバージョン管理が可能。AMIと独立して設定ができる。
    - AMIは「起動テンプレートに含めない」という設定が可能。
  - 双方とも、Auto Scalingグループに紐づけする。
  - そのAuto ScalingグループをELBに紐づけすることが可能。

- インスタンス間のネットワーク高速化
  - クラスタープレイスメントグループを設定する。
  - 拡張ネットワーキングをサポートするインスタンスタイプを選択

- プレイスメントグループ
  - クラスタープレイスメントグループ
    - パフォーマンス向上が目的。単一AZ内でグループ化し、複数のVPC Peeringにまたがることも可能。
    - グループ内のインスタンスは、TCP/IPトラフィックのスループット上限が高くなり、インスタンス間通信の速度が向上する。
  - パーティションプレイスメントグループ
    - 耐障害性が目的。
    - 複数パーティションに分けられ、パーティション毎にラックがあり、パーティション同士はラックを共有しない。
  - スプレッドプレイスメントグループ
    - 更なる耐障害性が目的。
    - パーティションあたり1インスタンス構成となり、異なるラックにそれぞれのインスタンスを配置できるグループ。

- VM Import/Export
  - オンプレ環境の仮想マシンをAWSにインポートする機能

### ELB

- ELBのみでは、Auto Scalingは実施できないので注意する。

- スケールイン・アウトの繰り返し抑制
  - クールダウンタイマーの値を見直す。
  - CloudWatchと連携して、スケールが設定されるがその際のアラーム閾値を見直す。

- スティッキーセッション
  - セッション中に同じユーザから来たリクエストを同一インスタンスで処理することが可能。

### Lambda

- 制限
  - 一時ボリューム量(`/tmp`): 512MB
    - 2022/03/24のアップデートで、デフォルト512MB、最大10GBまでを設定可能となった(料金は必要)。
  - 同時実行数: 1000
  - 関数とレイヤーストレージ: 75GB

### ECS

- 権限付与
  - ECSにより起動するインスタンスへの権限は、ECSタスクにIAMロールを付与することにより行う。
  - 今まではEC2のIAMロールを使用する必要があった。

- 起動モード
  - EC2
    - EC2インスタンスを起動する。
  - Fargate
    - ECS・EKSで利用できる専用のコンピューティングエンジン
    - インスタンスの管理が不要(CPUやメモリなどを定義する)
    - 秒単位で数万個のコンテナ起動が可能

### Auto Scaling

- 簡易スケーリングポリシー
  - ターゲット追跡スケーリングポリシーの通常設定
  - アラーム設定に基づき１段階のスケーリングを実施

- ステップスケーリングポリシー
  - アラーム超過サイズに基づいて、インスタンス数を動的に調整する、複数段階のスケーリングを実施
  - これにより、段階的なウォームアップ条件を設定可能

- 手動スケーリング
  - 希望容量を手動で調整する。

- スケジュールされたスケーリング
  - 実施日時を指定する。

- スケールに24時間失敗し続けると、AUto Scalingが停止する可能性がある。

---
## Security

### AWS STS

- スイッチロールなどに使用
- またモバイルアプリケーションで一時的な認証情報を使用する際にも使用可能。
- SAML2.0をサポート
  - 異なるドメイン間でユーザー認証を行うためのXMLベースの標準規格。
  - SSOなどの要件に利用される。

### HSM

- Hardware Security Module
- HSMはゼロ化してキーをロスすると、コピーを有していない場合は、新しいキーは取得不可能となる。

### AWS WAF

- HTTPリクエストレベルでの制限・許可などを行う。
  - 特定のリクエスト以外を許可（攻撃を社団）
  - 特定のリクエストのみを許可（アクセス制限：日本国内のみ）

- Refer制限
  - 直前に参照していたURLに基づいて制限を行う。

---
## Messages

### SQS

#### 制限

- キューの保持期間はデフォルト4日間。最大で14日(2週間)。

#### キューの削除

- キューは明示的に削除しない限り、残り続ける。
- また可視性タイムアウトが設定されている場合は、有効期限が過ぎれば別のインスタンスでキューが処理される。
- 失敗し続けた場合は、デッドキューに移動する設定を行うことができる。

