# S3

## S3概要

### ストレージの種類

- S3はオブジェクトストレージとなる。
  - 安価かつ高い耐久性

- その他には以下がある。
  - ブロックストレージ
    - EBS, インスタンスストア
  - ファイルストレージ
    - EFS

### S3とは

- Simple Storage Service

- 特徴
  - 容量制限なく保存可能なマネージド型
  - 月額1GB/約2.5円
  - 高い耐久性 99.999999999%(eleven nine)
  - 冗長化
  - データ容量に依存しない性能が保証
  - 転送中や保存時に暗号化が可能
    - 設定が必要
    - Glacierは自動で暗号化される。

- 保存形式
  - バケット
    - 保存場所で名前はグローバルでユニークである必要がある。
  - オブジェクト
    - S3に格納されるファイルで、URLが付与される。
    - バケット内のオブジェクトは無制限
  - データサイズ
    - 0kBから5TBまで保存可能。

### S3のオブジェクト構成要素

- Key
  - オブジェクトの名前。バケット内のオブジェクトは一意に識別。
- Value
  - データそのもの。バイトデータで構成される。
- Version ID
  - バージョン管理を有効とする場合その管理に用いるID。
- metadata
  - オブジェクトに付随する属性の情報。
- sub resource
  - ACLなど管理するためのサポートを提供。

### S3のストレージタイプ

|タイプ|特徴|耐久性|可用性|
|:---|:---|:---|:---|
|STANDARD|基準。この中では最も高いが標準。|99.999999999%|99.99%|
|STANDARD-IA|低頻度アクセス用。スタンダードに比べて安価|99.999999999%|99.9%|
|One Zone-IA|可用性が99.5%に低下。安全ではなくてもよいデータ。バックアップの一時用途など。|99.999999999%|99.5%|
|RRS(Reduced Redundancy Storage)|低冗長化ストレージ。耐久性が低下。非推奨でアップデートされておらず、スタンダードよりも高いため現在は使わない。|99.99%|99.99%|
|Amazon Glacier|最安のアーカイブ用ストレージ。データ抽出に3～5時間を要する。迅速取り出しタイプでも1～5分必要。|99.999999999%|N/A|

- 耐久性
  - データが失われない確率。
- 可用性
  - サービスが停止する確率(頻度)。

### S3 Intelligent-Tiering

- 低頻度アクセスのオブジェクトを自動的に低頻度アクセス層に移動することでコストを削減する。
- 低頻度アクセス層の法が値段が安いが、取り出しに時間がかかるレイヤ。
- 基本的には30日間アクセスがないと低頻度アクセス層に移動する。
- 低頻度アクセス層のデータをアクセスした場合は、自動的に高頻度アクセス層に戻る。

### S3のpricing

- 以下に応じて課金される。
  - 保存データ容量
  - データ取得リクエスト
    - PUT, COPY, POST, LIST
    - GET, SELECT, その他
  - データ転送アウト
    - インは無料
    - アウトは有料
      - 1GB/monthまでは無料。
      - 転送費用がもっとも掛かると思ってよい。(約0.1USD/GBなど)

- 値段はリージョンによって多少変動する。

### S3の整合性モデル

- 高い可用性を実現するため、データの更新・削除には結果整合性モデルを採用している。
- 同時書き込みはタイムスタンプ順に処理。
- 整合性モデル
  - CREATE: Consistency Read
  - UPDATE: Eventual Consistency Read
  - DELETE: Eventual Consistency Read

- 整合性モデルとは？
  - 同時に複数の人がデータにアクセスした際の取り決め

- 結果整合性
  - 変更中のデータが完了していない場合でも他の人は古いデータを参照できる。
  - つまり、参照しているデータが古い可能性がある。
- 強整合性
  - 変更中のデータが完了するまで他の人は参照できない。
  - 見えているものは最新であることが保証される。

### S3のアクセス管理

- IAMユーザーポリシー
  - IAMユーザー・リソースに対してS3へのアクセス権限を設定することが可能。
  - S3サービスへの権限となる。個々のバケットなどへの設定は、バケットポリシーやACLで実施する。
- バケットポリシー
  - アクセス権をJSONで設定。
    - IPアドレスを制限したり、など。
  - 他アカウントへの許可も可能。
  - バケット単位の高度なアクセス管理向け。
- ACL
  - バケットと個々のオブジェクトへのアクセス権限をXMLで設定する。
  - 他アカウントへの許可も可能。
  - 簡易的なアクセス管理向け。
- 署名付きURL
  - AWS SDKで作成した署名付きURLでS3のオブジェクトへの一定時間アクセスを許可。

- S3はインターネットからのパブリックアクセスが可能。
  - デフォルトはオフの設定でる。

### S3の暗号化

- SSE-S3(Server Side Encryption)
  - S3の標準暗号化方式で簡易に利用可能。
  - キーの作成・管理をS3で自動で実施。
  - AES-256でデータを暗号化。

- SSE-KMS
  - AWS KMSに設定した暗号化キーを利用した暗号化。
  - ユーザー側でキーを作成・管理することが可能。
  - クライアント独自の暗号キーを利用可能

- SSE-C
  - ユーザーが指定したキーによるサーバー側の暗号化を使用することが可能。
  - 利用設定や管理が煩雑。
  - マネジメントコンソールではなくSDKなどを使用した設定が必要。

- CSE(クライアントサイド暗号化)
  - S3に送信する前にデータを暗号化する方式。
  - AWS KMSなどを利用してキー作成を実施。
  - アプリケーション内に保存したマスターキーを使用。

## S3アクセスポイント
