# S3

## S3概要

### ストレージの種類

- S3はオブジェクトストレージとなる。
  - 安価かつ高い耐久性

- その他には以下がある。
  - ブロックストレージ
    - EBS, インスタンスストア
  - ファイルストレージ
    - EFS

### S3とは

- Simple Storage Service

- 特徴
  - 容量制限なく保存可能なマネージド型
  - 月額1GB/約2.5円
  - 高い耐久性 99.999999999%(eleven nine)
  - 冗長化
  - データ容量に依存しない性能が保証
  - 転送中や保存時に暗号化が可能
    - 設定が必要
    - Glacierは自動で暗号化される。

- 保存形式
  - バケット
    - 保存場所で名前はグローバルでユニークである必要がある。
  - オブジェクト
    - S3に格納されるファイルで、URLが付与される。
    - バケット内のオブジェクトは無制限
  - データサイズ
    - 0kBから5TBまで保存可能。

### S3のオブジェクト構成要素

- Key
  - オブジェクトの名前。バケット内のオブジェクトは一意に識別。
- Value
  - データそのもの。バイトデータで構成される。
- Version ID
  - バージョン管理を有効とする場合その管理に用いるID。
- metadata
  - オブジェクトに付随する属性の情報。
- sub resource
  - ACLなど管理するためのサポートを提供。

### S3のストレージタイプ

|タイプ|特徴|耐久性|可用性|
|:---|:---|:---|:---|
|STANDARD|基準。この中では最も高いが標準。|99.999999999%|99.99%|
|STANDARD-IA|低頻度アクセス用。スタンダードに比べて安価|99.999999999%|99.9%|
|One Zone-IA|可用性が99.5%に低下。安全ではなくてもよいデータ。バックアップの一時用途など。|99.999999999%|99.5%|
|RRS(Reduced Redundancy Storage)|低冗長化ストレージ。耐久性が低下。非推奨でアップデートされておらず、スタンダードよりも高いため現在は使わない。|99.99%|99.99%|
|Amazon Glacier|最安のアーカイブ用ストレージ。データ抽出に3～5時間を要する。迅速取り出しタイプでも1～5分必要。|99.999999999%|N/A|

- IAはinfrequency access（低頻度アクセス）

- 耐久性
  - データが失われない確率。
- 可用性
  - サービスが停止する確率(頻度)。

- Glacierにはいろんなタイプがある。
  - Glacier Instant Retrieval
    - ミリ秒単位で瞬時にアクセス可能。アクセスが４半期に一度程度を想定
  - Glacier Flexible Retrieval(旧Glacier)
    - 数分～数時間でアクセス可能。アクセスが年に一度程度を想定
  - Glacier Deep Archive
    - 数時間でアクセス可能。アクセスが年に一度未満を想定

### S3 Intelligent-Tiering

- 低頻度アクセスのオブジェクトを自動的に低頻度アクセス層に移動することでコストを削減する。
- 低頻度アクセス層の法が値段が安いが、取り出しに時間がかかるレイヤ。
- 基本的には30日間アクセスがないと低頻度アクセス層に移動する。
- 低頻度アクセス層のデータをアクセスした場合は、自動的に高頻度アクセス層に戻る。

### S3のpricing

- 以下に応じて課金される。
  - 保存データ容量
  - データ取得リクエスト
    - PUT, COPY, POST, LIST
    - GET, SELECT, その他
  - データ転送アウト
    - インは無料
    - アウトは有料
      - 1GB/monthまでは無料。
      - 転送費用がもっとも掛かると思ってよい。(約0.1USD/GBなど)

- 値段はリージョンによって多少変動する。

### S3の整合性モデル

- 高い可用性を実現するため、データの更新・削除には結果整合性モデルを採用している。
- 同時書き込みはタイムスタンプ順に処理。
- 整合性モデル
  - CREATE: Consistency Read
  - UPDATE: Eventual Consistency Read
  - DELETE: Eventual Consistency Read

- 整合性モデルとは？
  - 同時に複数の人がデータにアクセスした際の取り決め

- 結果整合性
  - 変更中のデータが完了していない場合でも他の人は古いデータを参照できる。
  - つまり、参照しているデータが古い可能性がある。
- 強整合性
  - 変更中のデータが完了するまで他の人は参照できない。
  - 見えているものは最新であることが保証される。

### S3のアクセス管理

- IAMユーザーポリシー
  - IAMユーザー・リソースに対してS3へのアクセス権限を設定することが可能。
  - S3サービスへの権限となる。個々のバケットなどへの設定は、バケットポリシーやACLで実施する。
- バケットポリシー
  - アクセス権をJSONで設定。
    - IPアドレスを制限したり、など。
  - 他アカウントへの許可も可能。
  - バケット単位の高度なアクセス管理向け。
- ACL
  - バケットと個々のオブジェクトへのアクセス権限をXMLで設定する。
  - 他アカウントへの許可も可能。
  - 簡易的なアクセス管理向け。（このオブジェクトのみを公開したい場合など）
- 署名付きURL
  - AWS SDKで作成した署名付きURLでS3のオブジェクトへの一定時間アクセスを許可。

- S3はインターネットからのパブリックアクセスが可能。
  - デフォルトはオフの設定でる。

### S3の暗号化

- SSE-S3(Server Side Encryption)
  - S3の標準暗号化方式で簡易に利用可能。
  - キーの作成・管理をS3で自動で実施。
  - AES-256でデータを暗号化。

- SSE-KMS
  - AWS KMSに設定した暗号化キーを利用した暗号化。
  - ユーザー側でキーを作成・管理することが可能。
  - クライアント独自の暗号キーを利用可能

- SSE-C
  - ユーザーが指定したキーによるサーバー側の暗号化を使用することが可能。
  - 利用設定や管理が煩雑。
  - マネジメントコンソールではなくSDKなどを使用した設定が必要。

- CSE(クライアントサイド暗号化)
  - S3に送信する前にデータを暗号化する方式。
  - AWS KMSなどを利用してキー作成を実施。
  - アプリケーション内に保存したマスターキーを使用。

## S3アクセスポイント

- S3上のデータを使用するアプリケーションへのアクセス管理を実施。

- 手順
  - アクセスポイントを作成
  - アクセス制限を設定（特定のIPやウェブサービスなど）
  - VPCに対して特定のS3バケットへのアクセス制限を設定
  - アプリケーション向けのアクセス対象を制限・拡大などをコントロール

- バケットポリシーとの違い
  - バケットポリシーはバケットに一つのみ設定できる、共通の設定。
  - 複数の設定やより複雑なアクセス制限はアクセスポイントで実現できる。
    - ユーザーによって権限を変えるなど。

### オブジェクトlambdaアクセスポイント

- オブジェクトを何かしら変換してそのデータを取得することが可能。

### マルチリージョンアクセスポイント

- 複数のリージョンにある複数のバケットを一つのアクセスポイントに接続できる。

## S3アクセスアナライザー

- 外部ユーザーにも公開して使われるユースケースも多いため、アクセスアナライザーが存在する。

- アクセスポリシーに沿っているかを確認。
  - 不正なアクセスが発生してないか
- IAMアクセスアナライザーを有効化して、S3に適用させたもの。
- 監視対象は対象は以下
  - バケットポリシー
  - ACL
- パブリックアクセスや共有バケットの設定なども確認できる。

## ブロックパブリックアクセス設定

- パブリックアクセスはデフォルトを設定できる。
- 初期状態ではブロックの設定となっている。

## ライフサイクル管理

- バケット内のオブジェクト単位でストレージタイプの変更や削除時期などを設定し、自動化できる。
  - バケット全体やprefixに設定
  - 毎日0:00UTCにキューを実行
  - 最大1000個のルールを設定可能
  - IAに移動できるのは128KB以上のオブジェクト
  - MFA Deleteが有効の場合、設定不可。

## レプリケーション

- デフォルトでも複数AZで冗長性を持つが、クロスリージョンでレプリケーションすることで更に耐障害性を高められる。
- リージョンに別々のバケットを作成し、レプリケーションを設定する。
- トリガー
  - create, update deleteなどをトリガにする。
- バージョン機能を有効にする必要がある。
- 双方向にレプリケーションすることも可能。
- データの転送には費用がかかる。

## バージョン管理

- ユーザーによる誤操作で削除・上書きされてしまってもバージョンから復元が可能。
- バージョン毎にデータが作成されるため容量を使用してしまう。
- そのため、ライフサイクル管理により保存する期間も指定可能。

## バックアップ

- Glacierを利用してバックアップと復元が可能。
- ライフサイクル設定によりGlacierに移動させることができる。

## S3利用状況の確認

### S3の分析(ストレージクラス分析)

- データのアクセスパターンの可視化が可能。
- CSV形式で出力可能。
- アクセス頻度の低いデータや保存期間を確認し、ライフサイクルポリシー設定に活かすことが可能。

### イベントの通知

- バケット内のイベント発生をトリガーにしてSNS/SQS/Lambdaに通知設定が可能。
- シームレスなシステム連携処理を実現。

## S3データの解析

- 用途に応じて複数サービスから選択が可能。

- S3 Select (Glacier Select)
  - S3内で直接クエリを実行しデータを取得できる。
  - 検索に使うイメージ。
  - gzipデータや、CSV、JSONに対して実行可能

- Amazon Athena
  - S3内のデータを直接・簡単に分析できるようにするインタラクティブなクエリサービス
  - より複雑なクエリを実行する場合に使用。分析に使うイメージ。
  - Athena SQL クエリで、SageMaker機械学習モデルを呼び出し、推論することも可能。

- Amazon Macie
  - 機械学習によりS3の機密データを検出・分類・保護できるフルマネージド型サービス。
  - 機密データ検出や調査を実施できる。
  - コンプライアンス調査などに使用する。

- Amazon Redshift Spetrum
  - S3の格納データに対して、Amazon Redshiftから直接クエリを実行できる機能。
  - Redshiftクラスターが必要なため、Redshiftを使用している場合はお勧め。

## CORS

- 同じドメインからしか通常データにアクセスできないが、それを回避するCORSの設定。
- これがS3でもできる？

## マルチパートアップロード

- 大容量のデータを分割してアップロード可能。
  - 最大サイズは5TB。
  - 分割は5MB～5GBのサイズ。ただし最後は5MB以下でもOK。
  - 分割数は1～10,000を指定可能。
- 失敗した場合はパートデータが残る。ライフサイクル管理でクリーンアップ設定が可能。

## バッチオペレーション

- S3オブジェクトの大量データに対して一括処理が可能。
  - 数十億などのオーダーでも実施可能。
- ジョブ
  - ジョブを作成し、実行するために必要な情報を登録。
  - オブジェクトのリストを渡し、それらのオブジェクトに対して実行するアクションを指定。
- マニフェスト
  - オブジェクトキーをリストするS3オブジェクト
  - マニフェストオブジェクトキー、ETAG、およびオプションでバージョンIDを指定。
  - S3インベントリレポート、CSVファイルの２つの形式で設定可能。

## Storage Lens

- ストレージの使用状況とアクティビティの傾向を可視化することができる。
- ただしrootアカウントでは使用できず、IAMアカウントでアクセスする必要がある。

### AWS Organizationsの設定

- Organizationsで管理している複数アカウントについてもStorage Lensを使用することが可能。

## S3のMarketplace

- バックアップやデータ分析などのS3用のソフトウェアを確認可能。

## Tranfer Acceleration

- 高速エンドポイントを使用して転送を高速化する。

## リクエスタ支払い

- データを取り出したアカウント側に課金するための仕組み

## 静的ウェブサイトホスティング

- 静的なウェブサイト（動きのない）はS3でデプロイできる。

## S3の用途

- 大量データを長期保存するという観点から以下が挙げられる。
  - コンテンツの配信・保管
  - ログ・バッチの保管
  - バックアップ、ディザスタリカバリ
  - Webの静的ホスティング
    - ランディングページ程度であれば安く済ませることができる。
    - 独自ドメインをバケット名として指定。任意のドメインへのリダイレクト機能など。
    - 異なるドメインからのアクセスを実現するためにはCORSを利用。
    - CloudFrontと連携して高速で配信することも可能。
  - データレイク
    - S3やGlacierに保存する。
    - 分析や短期用にはRedshiftを使うなどのすみわけ


## S3の実際の動作

### S3の作成

- S3はリージョンを指定して作成する（AZではないし、VPCも指定しない）。
- 既存のバケットからコピーすることも可能。
- ACLの設定
- ブロックパブリックアクセス設定
- バケットのバージョニング
- 暗号化
  - マネジメントコンソールで指定可能なのはSSE-S3とSSE-KMSのみ。
- オブジェクトロック
  - 削除または上書きを無効にする機能。監査ログの保存用など。
  - 有効にするためには、バージョニングが有効である必要がある。

### S3のプロパティ

- バージョニング
- タグ
- 暗号化
- Intelligent-Tiering Archive
- サーバーアクセスログの記録
- CloudTrailデータイベント
- イベント通知(EventBridge)
- Transfer Acceleration
- ロック
- リクエスタ支払い
- 静的ホスティング

### S3のアクセス許可

- ブロックパブリックアクセス
- バケットポリシー
- オブジェクト所有者
- ACL
- CORS
  - 静的ホスティング時に使用

### S3のメトリクス

- バケットサイズやオブジェクト数
- ストレージクラス分析
- レプリケーションのメトリクス

### S3の管理

- ライフサイクルルール
- レプリケーションルール
- インベントリ設定
  - オブジェクトのリストなどを収集

### S3のアクセスポイント

- アクセスポイント

### オブジェクトのアップロード

- アップロード時に以下が変更可能
  - バージョニングの有効化
  - ACLの設定
  - ストレージクラスの選択
  - 暗号化の設定

### パブリックアクセスの設定

- パブリックブロックアクセスをオフにする。
- ACLの有効化
  - 以下のアカウント毎に設定ができる。
    - バケット所有者
    - 全員 (パブリックアクセス)
    - Authenticated User (AWSアカウントをもつすべてのユーザー)
    - S3ログ配信グループ？
  - 全員を選択すれば、パブリックアクセスとなる。
- 公開したいオブジェクトを選択し、オブジェクトアクションで「ACLを使用して公開する」を実施。

### 署名付きURL

- 特定のユーザーへ一時的に公開したい場合などに署名付きURLを使用する。
- 公開したいオブジェクトを選択肢、オブジェクトアクションで「署名付きURLで公開する」を実施。
- URLを知っている人のみがアクセスできる
- 有効な時刻を設定することが可能。
- パブリックブロックアクセスを有効化してもアクセスできる。

### バージョニングの有効化

- バケットの設定で有効化できる。
- 更新した場合は、再度公開設定を実施する必要がある。
- 削除をしてものも、オブジェクトのバージョンリストの表示で確認することができる。
- バージョン自体の完全な削除は、MFAを有効化して安全にすることも可能
  - これには、マネジメントコンソールでは実行できないため、CLIやAPIでの設定が必要。

### Intelligent tiering archive

- 通常のIntelligent-Tieringとは違い、Glacierを使う。

- GlacierとGlacier Deep Archiveに低頻度のデータを移動することができる。
  - Glacierは3～5時間取り出しに掛かる。
  - 日数を指定する。
  - Deep Archiveは最大12時間かかる
  - 年に1回程度しかアクセスしないものを置くと良い。

### アクセスログの有効化

- 同じバケットのフォルダにも保存が可能。

### イベント通知の設定

- prefixやsuffixを指定することができる。
- イベントのPUT, POSTなど操作毎に記録するかどうかを設定できる。
- lambda, SNS, SQSなどの送信先と連携できる。
  - 送信先のリソースは作成が必要。

### Transfer acceleration有効化

- グローバルなロケーションを使って高速化エンドポイントを使う。
- この機能はバケット全体に設定される。
- 有料？？

### リクエスタ支払いの有効化

- データ転送アウトとリクエスト数に応じた分の料金を、実行したAWS側に課金することができる。

### 静的Webホスティング

- 静的Webサイトと他のデータのバケットの混在はあまりしない方がよい。
- 専用のバケットを作成する。
- 公開する際はACLを有効化、パブリックアクセスブロックをオフにする必要がある。
- 静的ウェブサイトを有効化する。

- ホスティングタイプは２つある。
  - 静的ウェブサイトのホスト
  - オブジェクトのリクエストのリダイレクト

- リソースを指定する(index.htmlなど)。
- その他リダイレクトルールをJSONで設定可能。

- その後設定したリソースをACL経由で公開する。(普通のオブジェクト公開と同じ)

- それに加えてバケットポリシーを設定する必要がある。
  - なぜ？
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PublicReadForGetBucketObjects",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::bucket-name/*"
        }
    ]
}

```

### ライフサイクル管理

- ルールの作成
  - プレフィックスでフィルターしたり、すべてのオブジェクトに対して指定する。

- アクションを選択できる。（複数選択可）
  - オブジェクトの最新バージョンをストレージクラス間で移動
  - オブジェクトの非現行バージョンをストレージクラス間で移動
  - オブジェクトの現行バージョンを有効期限切れにする
  - オブジェクトの非現行バージョンを完全に削除
  - 有効期限切れのオブジェクト削除マーカーまたは不完全なマルチパートアップロードを削除

- オブジェクトの現行バージョンをストレージクラス間に移行する
  - GlacierからStandard-IAなど逆の設定はできない
  - 選択先には、Intelligence Tieringなども選択可能

- オブジェクトの非現行バージョンをストレージクラス間で移動
  - 最新でなくなった日付で指定

- オブジェクトの現行バージョンを有効期限切れにする
  - バージョンを自動的に作成し、現行バージョンを古いバージョンとする。
  - バージョニングが有効でない場合は削除される。
  - 「オブジェクトの現行バージョンをストレージクラス間に移行する」を指定している場合、それより後である必要がある。

- オブジェクトの非現行バージョンを完全に削除
  - 古いバージョンを削除する。

- 有効期限切れのオブジェクト削除マーカーまたは不完全なマルチパートアップロードを削除
  - そのまま

- 最後にタイムラインの概要が確認できる。