# AWS - SAA

## 概要(公式より)

## Udemy教育メモ

- Udemyページ
  - これだけでOK！ AWS 認定ソリューションアーキテクト – アソシエイト試験突破講座（初心者向け22時間完全コース）
    - https://www.udemy.com/share/101WKkBkccdF9VQXo=/

### Section1: 全体像の理解

- アカウントの作成、マネジメントコンソールログインまで。
- EC2やS3を使うっぽい。
- EC2立ち上げ
  - AMI(Amazon Machine Image)の選択。無料のAmazon Linux 2を選択。
  - マシンスペックに応じてインスタンスタイプが様々。
  - ワークロードに応じて選択する。
  - VPCはないとAWSを使えないのだが、デフォルトのものがあるのでそれを使える。
  - ここではほぼデフォルトで作成する。
  - タグはユーザーの利便性に使われ、ここではName: Udemyで作成する。
  - セキュリティグループの設定は、ファイアウォールのルールセットである。
    - SSH, HTTP, HTTPSなどのプロトコル、ポート番号
    - ソース(アクセス元)の設定
      - 0.0.0.0/0, ::/0ならIPv4, IPv6全ソース許可。
  - アクセス用のキーペアも作成が必要。
    - キーペアはインスタンス専用ではなく、使いまわしも可能。
- SSHアクセス
  - ec2-user@{public ip address}でアクセス可能。
  - 認証方式は秘密鍵。
  - 鍵のアクセス権が400以下の場合は変更が必要かもしれない。(Linuxの場合など)
  ```
  ssh -i {pem file} ec2-user@{pulib ip address}
  ```
  - EC2 instance connectを使えば、ブラウザからコンソールでログインも可能。
    - この場合、キーペアなども不要となる。
- EC2削除
  - 最後にEC2を削除する。

- 資格体系
  - 受ける順番は、CLF > SAA > SOA, DVA > SAP, DOPの順番が良い。

- SAA概要
  - 求められる能力
    - 顧客要件に基づいたアーキテクチャ設計原則を使ったソリューションを定義する。
    - プロジェクトのライフサイクル全体を通じて、ベストプラクティスに基づいた実装ガイダンスを組織に提供する。
  - 質問パターン
    - AWSサービスや特徴・機能の選択(CLFと重複)
    - AWSサービスの適切な設定方法の選択
    - AWSサービスを組み合わせた最適なアーキテクチャ構成の選択

- AWSの操作
  - AWSマネジメントコンソール、リソースに応じたサービス(SSHなど)、AWS CLIの３つある。
  - AWS CLIでしかできない操作があることに注意する。

- バージニア北部でしかできない操作がある。(us-east-1)
  - クォータの増加など。

- AWSのアカウントにもランクがある。
  - Basic, Developer, Business, Enterpriseなど。

- AWS CloudTrail
  - アクティビティログを取得できる。
  - S3に保存される。
  - 無料だがS3使用料金はかかる。
  - CloudWatchとの連携も可能だが、料金がかかる。
  - 管理イベントのみは無償だが、データイベント、Insightsイベントは有償。
  - ちなみに証跡を保存する設定をしなくても、90日間は閲覧することができる。
  - ログは、Athenaでも解析することができる。
  - データレイクの機能もあるようだ。
  - ログ記録の停止をすれば、これ以上の課金はされなくなる。

- CloudWatch
  - CPU使用率などのメトリクスを使用して監視することができる。
  - リソースを何か立ち上げると、メトリクスの収集は行われている。
  - メトリクスをダッシュボードに設定する必要がある。
  - 請求アラームは、リージョンによっては設定できないため、us-east-1に移動する。

- KMS: Key Management Service

- CIDRについて
  - https://wa3.i-3-i.info/word11989.html

- AZとリージョンの違い
  - https://aws.amazon.com/jp/about-aws/global-infrastructure/regions_az/

## IAM

- IAMポリシー
  - JSON形式で記述されたアクセス権限の設定のこと。
    - Effectは制御方法で、"Allow", "Deny"のみ。
    - Actionは対象の操作
    - Resourceは対象のAWSリソース
    - Conditionはアクセス制御が有効となる条件
  - IAMユーザ、IAMグループ、IAMロールに設定可能
  - 実例
  ```json
  {
    "Effect": "Allow",
    "Action": [
      "s3:ListBuckets",
      "s3:Get*",
    ],
    "Resource": [
      "arn:aws:s3:::mybucket",
    ],
    "Condition": {
      "IpAddress": {
        "aws:SourceIP": ["176.32.92.49/32"]
      }
    }
  }
  ```

- アカウント種類
  - 通常、以下のようなアカウントの種類で運用する。
    - ルートアカウント ... すべてのサービスとリソースの使用権原を有する。日常的には使わない。
    - 管理者権限(IAMユーザー) ... AdministratorAccessが許可されたIAMユーザー。IAMの操作も可能。
    - パワーユーザー(IAMユーザー) ... IAM以外のすべてのAWSサービスにアクセス権限を持つ。IAMは操作できない。
  
- ルートアカウントのみの権限
  - ルートアカウントのメアド、パスワード変更
  - IAMユーザーの課金情報へのアクセス権のactivate/deactivate
  - DNS関連
    - 他AWSアカウントへのRoute53のドメイン登録の移行
    - 逆引きDNS申請
  - AWSサポート等のキャンセル
  - AWSアカウントの停止
  - 一括請求（コンソリデーティッドビリング）の設定
  - 脆弱性診断フォームの提出

- IAMグループ
  - 組織単位でIAMポリシーを設定可能となる。

- IAMロール
  - AWSリソースに対してアクセス権限をロールとして付与できる。
  - また、アカウントの外部アクセスにも付与できる。(別のAWSアカウントなど)

- IAMポリシーのタイプ
  - ユーザーベースのポリシー
    - 管理ポリシー、インラインポリシーをIAMエンティティ(IAMユーザー、グループ、ロール)にアタッチする。
    - ユーザーベースのポリシーでは、アクセス許可はIAMエンティティに付与される。
  - リソースベースのポリシー
    - バケットポリシーなどのJSON形式で定義されたインラインポリシーをリソースにアタッチする方式。
    - リソース自体が固有のポリシーを持っているケースはこれ。
    - S3バケットポリシーやIAMロールの信頼ポリシーなど。
    - 他には、SNSのTopicポリシーやVPCエンドポイントポリシーなどあるようだ。
    - 詳細は下記。
      - https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/reference_aws-services-that-work-with-iam.html
  - アクセス許可の境界
    - ユーザーベースのポリシーがIAMエンティティに付与できる許可の上限を設定する機能
    - アクセス許可を付与することはできない。

- 管理ポリシー
  - AWS管理ポリシーは、AWSがすでに準備しているポリシーである。
  - カスタマー管理ポリシーは、AWSアカウントが作成・管理する管理ポリシーであり、同じポリシーを複数のIAMエンティティにアタッチできる。
  - ポリシーの変更時は、アタッチ済みのすべてのエンティティに変更が反映され、バーしょん管理も可能。
- インラインポリシー
  - １つのプリンシパルエンティティに埋め込まれた固有のポリシー。
  - ポリシー単体では存在できず、いずれか１つのエンティティにアタッチされる。
  - 意図しないアクセス権の変更が行われたくない場合に使用するが、基本的には、管理ポリシーの使用が推奨。

- IAMロールの信頼ポリシー
  - 一時的な権限移譲操作に特化したポリシー。
  - 具体例としては、監査人に一時的に監査ログへのアクセス権を付与したい場合など。
  - 以下に具体的な例がある。
    - https://dev.classmethod.jp/articles/iam-role-externalid/
  - この例では以下のような手順で使用される。
    - 私のAWSアカウントで外部(Example Corp.)向けのIAMロールを作成し、IAMロールのARNをExample Corp.に伝える。
    - このIAMロールは、信頼されたエンティティに、Example Corp.のAWSアカウントを指定しておく。
    これにより、Example Corp.以外がAssumeRoleすることはできない。
    - Example Corop.は、このARNを使用してAssumeRoleし、私のAWSアカウントのリソースにアクセスが可能となる。
  - ちなみにこの例では、外部IDというものをConditionに使い、ARNが漏洩した場合に、第３者に、Example Corp.のSaaSを介して、
  不正アクセスされないようにするため、という理由を説明している。
  - IAMユーザを一時的に作成し、削除するという使い方でも一時的な権限移譲はできるが、
  IAMユーザ作成は基本永続的な対応に使用されるため、信頼ポリシーを使うことが推奨される。
  - SaaSによっては、IAMロールではなくアクセスキーしか対応してない場合のあり得る。

- IAMの認証方式
  - アクセスキーIDとシークレットアクセスキー
    - EC2インスタンス接続などのREST、AWS CLI、APIを使用した認証で使用。
  - X.509 Certificate
    - SOAP形式のAPIリクエスト向けの認証方式。
    - SOAPはRESTより歴史が古く、より厳格な標準化の元管理され、XMLでのメッセージングを行う。
  - AWSマネジメントコンソールへのログインパスワード
    - デフォルトは未設定
  - MFA(多要素認証)
    - 推奨されているピンコード等での認証方式

- ユーザーのアクティビティ記録方法
  - IAMアクセスアナライザー
    - 外部アカウント(エンティティ)と共有しているS3やIAMロールを分析し、意図しないアクセスをリスクとして特定
  - Access AdvisorのService Last Accessed Data
    - IAMエンティティが最後にAWSサービスにアクセスした日付と時刻を表示する機能
  - Credential Report
    - IAM認証情報の詳細なレポートを取得できる。
  - AWS Config
    - IAMのユーザ、グループ、ロール、ポリシーの変更履歴を管理、確認できる機能
  - AWS CloudTrail
    - AWSインフラ全体のアカウントアクティビティをログに記録して監視できる機能。
  - その他のロギング機能としては以下も使用可能
    - Amazon CloudFront
      - ユーザーリクエストを記録できる。
    - Amazon S3
      - アクセスリクエストを記録できる。
    - Amazon CouldWatch
      - リソースとアプリケーションを監視し、定義したメトリクスに基づいてアラームを設定可能。
  
- IAM権限のベストプラクティス
  - ルートアカウントのアクセスキーをロックし、ルートアカウントを使用しない。
  - 個々のIAMユーザーを作成して、IAMユーザーで管理を行う。
  - IAMユーザーへのアクセス許可には、IAMグループを介して行う。
  - アクセス許可は最小権限のみを設定する。
  - カスタマー管理ポリシーよりも、AWS管理ポリシーを使用できないか検討する。
  - インラインポリシーよりも、カスタマー管理ポリシーを使用できないか検討する。
  - アクセスレベルを使用してIAMアクセス許可を確認する
    - ReadOnlyやFullAccessなど、適切なものをという意味。
  - 強度の高いパスワードポリシーを設定する。
  - MFAを有効化する。
  - EC2インスタンスで実行するアプリケーションにはIAMロールを使用する。
    - EC2インスタンスにアクセスキーなどを配置せず、IAMロールを使って制御しろという意味と思われる。
    - アクセスキーが必要なのは、AWSの外部からアクセスする場合のみである。
  - 第三者に一時的に認証を付与する場合はIAMロールを使用する。
    - IAMロールの信頼ポリシーを参照。
  - アクセスキーを共有しない。
  - 認証情報は定期的にローテーションする。
  - 不要な認証情報を削除する。
  - AWSアカウントのアクティビティを監視する。
    - アクティビティ記録方法を参照。

  - 公式は以下の通り。
    - https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/best-practices.html

## IAM機能の説明

- Policy Simulator
  - IAMやOrganizationで、複数のポリシーを設定した場合に、うまく権限付与されているかを確認するツール。
  - OrganizationsにおけるSCPなどの他のポリシーに対しても使える。
    - Organizationsは複数のAWSアカウントを管理するサービス。
    - SCPはそのポリシーで、AWSアカウントのアクセスを制御する。
    (IAMポリシーは、IAMエンティティのアクセスしか制御できないのでそこｔが異なる。)

- Web Identity Federation Playground
  - ID Federationを使って、SSOやオンプレのAD(Active Directory)と連携する場合がある。
  - その際のIdP(IDプロバイダ)での認証情報や一時的なtokenを取得するためのツール

- IdP(IDプロバイダ)
  - Federation Accessを実現するもの。
  - ADというオンプレの認証の仕組みとIAMを連携し、統合管理できるようにする機能。
  - AWS外のユーザーIDを管理し、アクセス許可などを制御できる。

- STS(Security Token Service)
  - 一時的な認証情報を付与する機能.
  - アカウント設定から、リージョン毎のエンドポイントでの有効・無効を設定できる。

- アクセスレポート
  - アクセスアナライザー
    - 認証情報の分析、不正なアクセスなどを分析できる。
  - 認証情報レポート
  - 組織アクティビティ
    - Organizationsを使用している場合に使う。
    - Organizationsにおけるアクティビティを見ることが可能。
  - SCP
    - Organizationsを使用している場合に使う。
    - AWSアカウントのアクセス権をコントロールするポリシー。

## ポリシーの作成

### 開発グループ用
- リソースで絞り込んで、アクションを選択する。VPC関連のアクションはなぜかEC2リソースの中にあるので、注意する。
- EC2, ELB, AutoScaling, RDS, S3のサービスについて、すべてのアクション、すべてのリソースを許可してポリシーを作成。
  - AutoScalingなど、リソースを指定できないものもあり、その場合は勝手にすべてのリソースとなる。

### 運用グループ用
- CouldWatch, CouldTrail, Configについて作成

## ロールの作成

- ロールの種類として以下がある。
  - AWSサービス用
  - 別のAWSアカウント用
  - ウェブID ... WebIDプロバイダを使ってFederationによって外部認証をする機能があり、それを使うCognito、STSなどの場合に使用。
  - SAML 2.0 Federation ... ADなどで使われる方式。ADと統合してIAMを使っていく場合に使用。


## IAM参考

- [AWS]管理ポリシーとインラインポリシーの違いが分からなかったので改めてIAMポリシーのお勉強をする
  - https://qiita.com/Batchi/items/a2dde3d2df27568cc078

- セッションポリシーというものもあるらしい。
  - https://docs.aws.amazon.com/ja_jp/transfer/latest/userguide/session-policy.html

- IAMポリシーとSCPの違い
  - https://aws.amazon.com/jp/premiumsupport/knowledge-center/iam-policy-service-control-policy/