# AWS - SAA

## 概要(公式より)

## Udemy教育メモ

- Udemyページ
  - これだけでOK！ AWS 認定ソリューションアーキテクト – アソシエイト試験突破講座（初心者向け22時間完全コース）
    - https://www.udemy.com/share/101WKkBkccdF9VQXo=/

### Section1: 全体像の理解

- アカウントの作成、マネジメントコンソールログインまで。
- EC2やS3を使うっぽい。
- EC2立ち上げ
  - AMI(Amazon Machine Image)の選択。無料のAmazon Linux 2を選択。
  - マシンスペックに応じてインスタンスタイプが様々。
  - ワークロードに応じて選択する。
  - VPCはないとAWSを使えないのだが、デフォルトのものがあるのでそれを使える。
  - ここではほぼデフォルトで作成する。
  - タグはユーザーの利便性に使われ、ここではName: Udemyで作成する。
  - セキュリティグループの設定は、ファイアウォールのルールセットである。
    - SSH, HTTP, HTTPSなどのプロトコル、ポート番号
    - ソース(アクセス元)の設定
      - 0.0.0.0/0, ::/0ならIPv4, IPv6全ソース許可。
  - アクセス用のキーペアも作成が必要。
    - キーペアはインスタンス専用ではなく、使いまわしも可能。
- SSHアクセス
  - ec2-user@{public ip address}でアクセス可能。
  - 認証方式は秘密鍵。
  - 鍵のアクセス権が400以下の場合は変更が必要かもしれない。(Linuxの場合など)
  ```
  ssh -i {pem file} ec2-user@{pulib ip address}
  ```
  - EC2 instance connectを使えば、ブラウザからコンソールでログインも可能。
    - この場合、キーペアなども不要となる。
- EC2削除
  - 最後にEC2を削除する。

- 資格体系
  - 受ける順番は、CLF > SAA > SOA, DVA > SAP, DOPの順番が良い。

- SAA概要
  - 求められる能力
    - 顧客要件に基づいたアーキテクチャ設計原則を使ったソリューションを定義する。
    - プロジェクトのライフサイクル全体を通じて、ベストプラクティスに基づいた実装ガイダンスを組織に提供する。
  - 質問パターン
    - AWSサービスや特徴・機能の選択(CLFと重複)
    - AWSサービスの適切な設定方法の選択
    - AWSサービスを組み合わせた最適なアーキテクチャ構成の選択

- AWSの操作
  - AWSマネジメントコンソール、リソースに応じたサービス(SSHなど)、AWS CLIの３つある。
  - AWS CLIでしかできない操作があることに注意する。

- バージニア北部でしかできない操作がある。(us-east-1)
  - クォータの増加など。

- AWSのアカウントにもランクがある。
  - Basic, Developer, Business, Enterpriseなど。

- AWS CloudTrail
  - アクティビティログを取得できる。
  - S3に保存される。
  - 無料だがS3使用料金はかかる。
  - CloudWatchとの連携も可能だが、料金がかかる。
  - 管理イベントのみは無償だが、データイベント、Insightsイベントは有償。
  - ちなみに証跡を保存する設定をしなくても、90日間は閲覧することができる。
  - ログは、Athenaでも解析することができる。
  - データレイクの機能もあるようだ。
  - ログ記録の停止をすれば、これ以上の課金はされなくなる。

- CloudWatch
  - CPU使用率などのメトリクスを使用して監視することができる。
  - リソースを何か立ち上げると、メトリクスの収集は行われている。
  - メトリクスをダッシュボードに設定する必要がある。
  - 請求アラームは、リージョンによっては設定できないため、us-east-1に移動する。

- KMS: Key Management Service

- CIDRについて
  - https://wa3.i-3-i.info/word11989.html

- AZとリージョンの違い
  - https://aws.amazon.com/jp/about-aws/global-infrastructure/regions_az/

## IAM

- IAMポリシー
  - JSON形式で記述されたアクセス権限の設定のこと。
    - Effectは制御方法で、"Allow", "Deny"のみ。
    - Actionは対象の操作
    - Resourceは対象のAWSリソース
    - Conditionはアクセス制御が有効となる条件
  - IAMユーザ、IAMグループ、IAMロールに設定可能
  - 実例
  ```json
  {
    "Effect": "Allow",
    "Action": [
      "s3:ListBuckets",
      "s3:Get*",
    ],
    "Resource": [
      "arn:aws:s3:::mybucket",
    ],
    "Condition": {
      "IpAddress": {
        "aws:SourceIP": ["176.32.92.49/32"]
      }
    }
  }
  ```

- アカウント種類
  - 通常、以下のようなアカウントの種類で運用する。
    - ルートアカウント ... すべてのサービスとリソースの使用権原を有する。日常的には使わない。
    - 管理者権限(IAMユーザー) ... AdministratorAccessが許可されたIAMユーザー。IAMの操作も可能。
    - パワーユーザー(IAMユーザー) ... IAM以外のすべてのAWSサービスにアクセス権限を持つ。IAMは操作できない。
  
- ルートアカウントのみの権限
  - ルートアカウントのメアド、パスワード変更
  - IAMユーザーの課金情報へのアクセス権のactivate/deactivate
  - DNS関連
    - 他AWSアカウントへのRoute53のドメイン登録の移行
    - 逆引きDNS申請
  - AWSサポート等のキャンセル
  - AWSアカウントの停止
  - 一括請求（コンソリデーティッドビリング）の設定
  - 脆弱性診断フォームの提出

- IAMグループ
  - 組織単位でIAMポリシーを設定可能となる。

- IAMロール
  - AWSリソースに対してアクセス権限をロールとして付与できる。
  - AWSリソースにはIAMユーザーも含まれる。

- IAMポリシーのタイプ
  - ユーザーベースのポリシー
    - 管理ポリシー、インラインポリシーをIAMエンティティ(IAMユーザー、グループ、ロール)にアタッチする。
    - ユーザーベースのポリシーでは、アクセス許可はIAMエンティティに付与される。
  - リソースベースのポリシー
    - バケットポリシーなどのJSON形式で定義されたインラインポリシーをリソースにアタッチする方式。
    - リソース自体が固有のポリシーを持っているケースはこれ。
    - S3バケットポリシーやIAMロールの信頼ポリシーなど。
    - 他には、SNSのTopicポリシーやVPCエンドポイントポリシーなどあるようだ。
    - 詳細は下記。
      - https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/reference_aws-services-that-work-with-iam.html
  - アクセス許可の境界
    - ユーザーベースのポリシーがIAMエンティティに付与できる許可の上限を設定する機能
    - アクセス許可を付与することはできない。

- 管理ポリシー
  - AWS管理ポリシーは、AWSがすでに準備しているポリシーである。
  - カスタマー管理ポリシーは、AWSアカウントが作成・管理する管理ポリシーであり、同じポリシーを複数のIAMエンティティにアタッチできる。
  - ポリシーの変更時は、アタッチ済みのすべてのエンティティに変更が反映され、バーしょん管理も可能。
- インラインポリシー
  - １つのプリンシパルエンティティに埋め込まれた固有のポリシー。
  - ポリシー単体では存在できず、いずれか１つのエンティティにアタッチされる。
  - 意図しないアクセス権の変更が行われたくない場合に使用するが、基本的には、管理ポリシーの使用が推奨。

- IAMロールの信頼ポリシー
  - 一時的な権限移譲操作に特化したポリシー。
  - 具体例としては、監査人に一時的に監査ログへのアクセス権を付与したい場合など。
  - 以下に具体的な例がある。
    - https://dev.classmethod.jp/articles/iam-role-externalid/
  - この例では以下のような手順で使用される。
    - 私のAWSアカウントで外部(Example Corp.)向けのIAMロールを作成し、IAMロールのARNをExample Corp.に伝える。
    - このIAMロールは、信頼されたエンティティに、Example Corp.のAWSアカウントを指定しておく。
    これにより、Example Corp.以外がAssumeRoleすることはできない。
    - Example Corop.は、このARNを使用してAssumeRoleし、私のAWSアカウントのリソースにアクセスが可能となる。
  - ちなみにこの例では、外部IDというものをConditionに使い、ARNが漏洩した場合に、第３者に、Example Corp.のSaaSを介して、
  不正アクセスされないようにするため、という理由を説明している。

## IAM参考

- [AWS]管理ポリシーとインラインポリシーの違いが分からなかったので改めてIAMポリシーのお勉強をする
  - https://qiita.com/Batchi/items/a2dde3d2df27568cc078

- セッションポリシーというものもあるらしい。
  - https://docs.aws.amazon.com/ja_jp/transfer/latest/userguide/session-policy.html