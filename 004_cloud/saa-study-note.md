# SAA

---
## storage

### S3

- 冗長化
  - デフォルトでAZ冗長構成となっている。
  - さらに冗長構成を高めるためには、クロスリージョンレプリケーションを使用する。
    - 使用するためにはバージョニングが有効である必要がある。
  - クロスリージョンレプリケーション設定後は、アクションに応じて非同期にレプリケーションされる。
  - その際、今までのオブジェクトは手動で(CLIなどで、マネコンは不可)レプリケーションが必要。
  - また、双方向レプリケーションするためには、お互いに設定が必要。

- 高速化
  - prefix
    - 処理並列化の工夫として日付やタイプ別のprefixを付与し、prefix毎に並列化することが可能。
  - Transfer Acceleration
    - グローバルなサービスで長距離にわたって高速転送をする場合は、Transfer Accelerationを使用する。

- オンプレとの連携
  - ストレージゲートウェイを使用する。
  - 標準的なプロトコル(NFS, SMB, iSCSI)を使用可能。
  - ２つのタイプがある。
  - 保管型ボリューム
    - プライマリをローカル、AWSに非同期にバックアップ可能。
    - データは、EBSスナップショットとしてS3にバックアップされる。
  - キャッシュ型ボリューム
    - プライマリをS3として使用し、アクセスするデータをローカルに保持する。

- エンドユーザーへの一時アクセス許可
  - 事前署名付きURLを使用可能。

- ストレージクラス
  - Standard
    - 標準
  - Standard IA
    - 低頻度アクセス用
  - One-zone IA
    - 重要でなく、低頻度アクセス用
    - なぜかログファイルなら重要でないという解釈になる模擬問題もあって？となっているが...
  - RRS
    - より耐障害性が低く、Standardよりも高いため、非推奨方式
  - Glacier (Flexible Retrieval)
    - 長期保存用。
    - 最低保持期間が90日のため、それ以下で不要になる場合は他のクラスが選択肢となる。
    - 迅速読み取りも可能だが、数分のアクセス時間は必要。
    - 通常は、3～5時間で読み取り
    - 大容量取り出しは5～12時間で読み取り。
  - Glacier Instant Retrieval
    - より低頻度アクセスだが、取り出しはミリ秒単位(S3と同等)に必要なデータ向け。
    - 医用画像やニュースメディアなど。
  - Glacier Deep Archite
    - ～12時間で読み取り。

- ストレージクラス分析
  - アクセスパターンを分析し、適切なデータを適切なクラスに移行するタイミングを判断できます。

- 整合性
  - 2020年12月より、強い整合性モデルに変更されている。

- MFA認証
  - 誤って削除するのを防ぐ目的で、削除時にMFA認証を設定することができる。

- S3 Access Analyzer
  - AWSアカウントの外部からアクセスできるリソースに対してアクセス情報を分析する。

- 暗号化
  - 暗号化を有効にすることで、アクセスログなども自動で暗号化される。
  - バケット作成時ではなくとも、後から設定することが可能。
  - Storage GatewayやGlacierは、デフォルト設定で暗号化が有効となる。

- Vault lock (Glacier)
  - ロックにより変更禁止とすることにより、コンプライアンス管理を実施することが可能。

- S3 Select
  - オブジェクトのフィルタなども可能。
  - これにより必要なサブセットのみのオブジェクトを取得するなどが可能となる。
  - より複雑な分析の選択肢としては、AthenaやRedShift Spectrumなどがある。

- データの保護
  - オブジェクトのロックが可能。

- 静的ウェブサイト
  - URLは、`bucketname.s3-website-ap-northeast-1.amazonaws.com`となる。

- バージョニング
  - バージョニング可能なのはS3のみ。(EBSやEFSはバージョニングできない)

- ライフサイクル管理
  - S3は一定期間後のクラス変更や削除など様々なライフサイクルポリシーを設定可能。
    - EBSはライフサイクル設定できない(DLM定期スナップショットのみ)
    - EFSはIAに移動させる管理しか対応できない。
  - Glacierも一番最初の保存先選択した場合は、一定期間後に削除するポリシーなどを設定はできない。

### EBS

- EBSの種類
  - 汎用SSD
    - 通常用途。アプリケーションなどの環境用。
    - スループットについてはスループット最適化HDDより低い場合があるため注意が必要。
      - スループットは、gp3は1,000[MiB/sec]でgp2は250[MiB/sec]
      - IOPSはSSDの方が総じて良い。
  - Provisioned IOPS SSD
    - IOPSが16,000必要な高パフォーマンス用。
    - IOPSは容量に比例して最大64,000までプロビジョニング可能。(ただしNitro以外は最大32,000)
      - io1の場合、サイズ:IOPS = 1:50
      - io2の場合、サイズ:IOPS = 1:500
      - 参考
        - https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-volume-types.html#EBSVolumeTypes_piops
    - マルチアタッチも可能。
    - io2は最大スループットが1,000MB/secである
    - io2 Block Expressは最大スループットが4,000MB/secであり、最も性能が高い。
  - スループット最適化HDD
    - 500 MiB/sec程度の高スループット。
    - IOPSはSSDよりも低い。
    - ルートボリュームには設定不可。
  - コールドHDD
    - アクセス頻度の低い用途。
    - 250 MiB/sec程度のスループット。
    - ルートボリュームには設定不可。

- EBSの冗長化
  - ミラーリング(RAID1)は最も、回復性が高い。
  - その他には、スナップショットやAMIの作成があるが、回復性は低い。

- EBSのAZ・リージョン移動
  - 同じAZ内のインスタンスにしかアタッチできない。
  - EBS自体を移動することはできないため、スナップショットを作成し、別AZ・別リージョンで複製する必要がある。

- マルチアタッチ
  - プロビジョンドIOPSのみマルチアタッチが可能。

- DeleteOnTermination属性
  - インスタンス削除後もルートボリュームのEBSのデータを保持したい場合は、この属性を無効化することが必要。

- デタッチ方法
  - 停止すればデタッチすることが可能（終了までしなくてもよい）。

- Amazon DLM (Data Lifecycle Manager)
  - 定期スナップショットなどの設定が可能。
  - 保存先はS3だが、ユーザーが指定することができない。

- EBSの変更
  - ボリュームサイズやボリュームタイプはデタッチすることなく変更することが可能。
  - ただしボリュームサイズを減らすことはできない。
  - https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/requesting-ebs-volume-modifications.html#elastic-volumes-limitations

- ファイルシステムの作成
  - 新規のEBSをアタッチした場合は、ファイルシステムを作成する必要がある。
  - フォーマット後、マウントが必要。
  - マウントターゲットは不要(EFSのみ)

### EFS

- 接続方法
  - AZ毎に１つのマウントターゲットが必要
  - NFSv4を使用

- ライフサイクル管理
  - 自動的なファイルストレージ管理
  - 30日アクセスされなかったファイルをEFS IAクラスに移行する。
  - データ削除などのライフサイクル管理設定はできない。

- S3との比較
  - S3と異なりインターネットからの直接アクセスは不可能
  - EFSは強い整合性やファイルのロックなどが可能であり

### Snowball

- Snowball edge
  - 安全なデバイスを使用し、ペタバイト規模の大容量データを転送するサービス。
  - 物理的なハードウェアを用いた移転が可能。

- Snowball edge Compute Optimized
  - 42TBのHDD容量
  - 機械学習、動画分析向け。

- Snowball edge Storage Optimized
  - 100TBのHDD容量だが、利用可能な部分は80TB程度。

- 要する時間
  - 諸々で数週間は必要。

### 高機能なストレージのIOPS比較

- EBSのプロビジョンドIOPSは、最大64,000IOPSのベースラインまで。
- EFSは、500,000超のIOPSまで。
- Amazon FSx for Windowsは、数百万IOPSまで対応。
- Amazon FSx for Lustreは、スーパーコンピューター用。

### AWS Storage Gateway

- Amazon S3 File Gateway
  - NFSおよびSMBによりS3オブジェクトとしてファイルを保存できる。

- Amazon FSx File Gateway
  - SMBプロトコルを使用し、Amazon FSxにファイルを保存できる。

- Tape Gateway
  - iSCSIベースの仮想テープライブラリに保存ができる。

- Volume Gateway
  - iSCSIを使用したブロックストレージを提供する。
  - キャッシュ型と保存型の2種類がある。
  - 保管型ボリューム
    - プライマリをローカル、AWSに非同期にバックアップ可能。
    - データは、EBSスナップショットとしてS3にバックアップされる。
  - キャッシュ型ボリューム
    - プライマリをS3として使用し、アクセスするデータをローカルに保持する。

  - 接続を攻撃から保護するために、以下が必要。
    - CHAP（Challenge Handshake Authentication Protocol）を構成。
    - iSCSIとイニシエーター接続を認証する

---
## streaming

- Kinesis Data Stream
  - データ欠落がなく耐久性があり、重複無し・順序維持をした伝送が可能。

- Kinesis Data Streamのデータ保持期間
  - 保持期間のデフォルトは24時間。設定によっては365日まで変更可能。

- データに対する分析タスク
  - KCL(Kinesis Client Library)で実施可能。
  - Kinesisアプリケーションは、複数のインスタンスを持つことができ、KCLワーカーが各インスタンスに対応する処理ユニットです。
  - レコードプロセッサはKinesis Data Streamsのシャードからデータを処理するユニットです。
  - 1つのレコードプロセッサは1つのシャードに対応し、複数のレコードプロセッサがKCLワーカーにマッピングされます。

- Kinesis Firehose
  - S3やRedShift、Elasticsearch Serviceにロードできる。
    - DynamoDBを配送先に指定することができないので注意
  - lambdaと統合され、データ変換処理をしながら配信することが可能。

---
## Database

### DynamoDB

- マルチAZ構成は不可。

- Auto Scalingの設定はRead/Write双方ともに対応。
  - トラフィック変化に応じたスループット向上を行うことができる。

- 登録・変更などをトリガにlambda実行などをする場合は、DynamoDB Streamを有効化する。
  - この変更情報は最大24時間保存される。
  - Streamを使わずに、LambdaとCloudWatch Eventsを連携することでも構築可能。

- DynamoDB Accelerator(DAX)
  - 最大10倍のパフォーマンス向上が可能。
  - ただし高コストであり、恒常的な対策であるため、一時的な負荷増にはAuto Scalingを活用する。

- 整合性モデルの変更可能
  - 結果整合性と強い整合性を設定で変更することができる。

- LSI(local secondary Index)
  - 追加でソートキーを増やすイメージ
  - 1テーブルに５つ作成可能でテーブル作成時に作成
  - 検索を詳細にしたい場合などに使用。

- GSI(global secondary Index)
  - テーブル全体をスキャンして全体で何かを算出したい場合に使用する。
  - データに対して別のハッシュキーを設定できる。
  - 1テーブルに５つ作成可能、テーブル作成後に作成

- グローバルテーブル
  - リージョン間でのレプリケートが可能となる。
  - レプリカ間の変更の伝搬は、DynamoDB Streamsを使用して行われる。
  - 参考
    - https://aws.amazon.com/jp/blogs/news/how-to-use-amazon-dynamodb-global-tables-to-power-multiregion-architectures/

### RDS

- 対応インスタンスタイプ
  - T,MおよびR,X,Z

- マルチAZ構成は可能。
  - 目的は冗長化。これによりセカンダリーDBを別AZに構築し、フェイルオーバー構成が可能。

- 暗号化は、作成時に有効化可能。

- Auto Scalingはストレージ容量のみに対応。

- RDS ProxyによるLambdaとの連携
  - Lambdaと連携する場合は、RDS Proxyによりconnection poolを使って接続する。
  - これにより、同時接続数の制限に達しないようにすることが可能。
  - ファイルオーバーに対する耐障害性もあり、スタンバイ側に再接続が可能。
  - https://blog.serverworks.co.jp/2022/01/20/093110

- リードレプリカを利用したフェイルオーバーは不可。
  - Auroraではこれが可能。
  - 手動で昇格させることは可能。あくまで自動ができない。

- リードレプリカはデータにラグが発生する可能性がある。
  - 非同期にレプリケートされる別インスタンスであるため
  - 最新のトランザクションのいくつかを表示できない可能性がある。

- IAMデータベース認証
  - パスワード認証不要で、安全に特定リソースからRDSにアクセスすることが可能。
  - 手順
    - RDS側にログイン専用のユーザーを作成し、テーブルなどへの権限を設定。
    - IAMポリシーを作成し、Resourceに上記のユーザーID等を指定
    - ポリシーをEC2にアタッチする。
  - ご参考
    - https://blog.serverworks.co.jp/rds-iamdblogin

- モニタリング
  - 拡張モニタリングの有効化により、インスタンスのメトリクスが確認できる。
  - これはCloudWatch Logsにデフォルトで30日間保存される。

- RDSのベストプラクティス
  - エンジンはInnoDBを使用する(MyISAMは使用不可)
  - 自動バックアップを有効化する
  - 大きなテーブルのパーティションは16TBを超過しないようにする。

### Aurora

- 対応インスタンスタイプ
  - T,およびR,X

- 高速な回復性
  - リードレプリカ別リージョンに構成すれば、リージョン障害時でも使用することが可能。

- RDSとの比較
  - 一日のトランザクション数が10,000を超えるなどのケースはAuroraを選択する。

- マルチマスタ構成
  - Writerを複数別AZにスケーラブルに構築可能
  - どのノード、AZが落ちてもダウンタイムがゼロとなる
  - マルチマスタ構成の場合、すべてが読み書き可能なインスタンスのため、リードレプリカは利用できない。

- RDSからの移行
  - RDSのスナップショットを用いてAuroraに移行をする。


### Redshift

- ノードタイプ
  - RAおよびDC
  - RAはストレージ容量がマネージドである。

- マルチAZ構成は不可。
  - マルチAZ環境とするためにはぞれぞれにRedshiftを構成し、同じS3入力ファイルセットをロードして構成する必要がある。

- スポットインスタンスは使用不可。
  - オンデマンドおよびリザーブドのみ使用可能。

- クロスリージョンスナップショット
  - 障害時、クラスタの復旧に備えるために使用。
  - S3に自動的にスナップショットが保存されるようになる。

- 拡張VPCルーティング
  - これを有効にすると、通常のVPCと同様以下の設定が可能になります。
    - セキュリティグループ, ACL, VPCエンドポイント
  - 設定による料金は発生しません。
  - 逆に設定しない場合は、その他のAWSサービスなどへのトラフィックが、インターネット経由でルーティングされます。

- WLM (Work Load Management)
  - クエリに対して割り当てるRedshiftのリソースを指定することができる。
  - WLMによりクエリ処理をキューとして実行順序を定義可能。

### ElastiCache

- 高速データ処理が可能なNoSQL型のデータベース
- 単純に高速化したいなどの場合は、シンプルなMemcachedを選択する。
- レプリケーションや自動フェイルオーバー、データの永続性という面ではredisを選択する。

### AWS Database Migration Service

- オンプレにあるデータベースを短期間で安全にAWSへ移行できるサービス。

- DMSコンソールを利用して、移行対象のテーブル、以降方式をタスクとしてJSONファイルにより設定できる。

---
## Data Processing

### EMR

- 動的なスケーリングが可能

- データ集約型のタスクに有用
  - ログ解析
  - データマイニング
  - 科学シミュレーション

- クラスターとしてEC2インスタンスの集合を扱う

- EMRFSを使用してS3内のデータに直接アクセスすることが可能。

- ノードは３つ種類がある。
  - コアノード
  - マスターノード
  - タスクノード

- 低コスト化
  - コアノードとマスターノードをRIとし、タスクノードをスポットとする。

### AWS Data Pipeline

- データの移動や変換を自動化するためのサービス。
- DynamoDBなどに設定可能で、定期的なデータ取得タスクを設定可能。

### Amazon Athena

- S3内のデータを直接・簡単に分析可能な、インタラクティブなクエリサービス。
- SageMakerの機械学習モデルを呼び出し、推論なども実行可能。

---
## Network

### インターネット接続要件

- パブリックサブネットの場合、IGWがサブネットのルートテーブル設定されている。
- プライベートサブネットの場合、NATGWがサブネットのルートテーブル設定されている。
- NATGWがパブリックサブネットに設置されている。
- セキュリティグループの設定でインターネットアクセス許可がされている。(IGWもしくはNATGWに対して)
- ACL設定でインターネットが拒否されていない。
- パブリックIPアドレスが付与されている。(自動割り当てが有効化されている。)

### VPC

- VPC間接続にはVPC Peeringを使用する。
  - これは別のAWSアカウント間でも接続可能

- VPC Peeringで複雑になる場合は、Transit Gatewayを利用する。
  - これによりハブ・アンド・スポークス構成を使用できる。

- 設定可能なCIDR範囲は`/16 ～ /28`である。

- サイト間VPN
  - オンプレと接続する場合、それぞれに以下が必要。
    - カスタマーゲートウェイ(オンプレ側の接続点)
    - 仮想プライベートゲートウェイ(AWS VPC側の接続点)
  - VPNへの接続は、Client VPN Endpointから行う。

- VPC内のインスタンスにDNS名を取得するためには、DNSホスト名有効化オプションが必要。

- VPC Peeringはエッジ間ルーティング負荷
  - VPC-A, VPC-BがPeeringしている。
  - VPC-AがDirect Connectでオンプレと接続されていても、VPC-Bはオンプレと双方向に通信できない。

- VPCエンドポイント
  - インターネットを介さずにAWSリソースにアクセスできる。
  - S3とDynamoDBのみ、ゲートウェイ型
  - それ以外のリソースはプライベートリンク型

- Bastionホストとは
  - EC2などで構成する踏み台サーバーのこと。
  - publicサブネットに配置し、privateサブネット内のリソースアクセスをこのBastionホスト経由のみに限定する。
  - Bastionとは要塞という意味。

- セカンダリCIDR
  - IPアドレスが枯渇する場合、最大４つのセカンダリCIDARをVPCに追加できる。

- ポート
  - インバウンドはsshなどのポート番号を指定して解放する。
  - アウトバウンドも解放が必要で、1024-65536を解放する必要がある。
    - アウトバウンドはランダムに割り当たる。
    - その範囲はクライアントによって異なる。
      - Lambda, NAT-GW, ELBは1024-65536
      - 多くのLinuxは32768-65536
      - Windows Server 2003は1025-5000
      - Windows Server 2008以降は49512-65535

### DirectConnect

- 準備には数日が必要。

- 冗長化としてIPsec対応のハードウェアVPNを使用することができる。

### DirectConnect Gateway

- マルチリージョンのVPCに接続する際には、DirectConnect Gatewayが必要となる。

### Transit Gateway 

- 多数のVPCを管理することができる。
- またFirewallやIPSに接続することでセキュリティを管理することができる。
- AWS Transit Gateway network managerで、設定の変更が可能。(IPSの設定はここではできない)

### IPv6への対応

- IPv6 CIDRブロックをVPC, subnetに関連付ける。
- IPv6トラフィック用のルートテーブル更新
  - public subnetは、subnetからInternet Gateway(IGC)にIPv6トラフィックをルーティングする。
  - private subnetは、subnetからEgress-only Internet Gateway(EIGW)にIPv6トラフィックをルーティングする。
- SGをIPv6を含めるように更新する。
- ACLで制限されている場合、ACLのルールもIPv6に対応するように更新する。
- インスタンスタイプをIPv6対応のものに変更する。
- IPv6アドレスをインスタンスに割り当てる。
- インスタンスの設定がIPv6に対応していない場合、設定を変更する。

### ACL

- アウトバンド・インバウンドの設定
  - `Egress:true`でアウト、`Egress:false`でインとなる。

- ポート設定
  - HTTPは`80`、FTPは`20`、SSHは`22`などとなる。

- 特定のIPアドレスの攻撃からサブネットを保護するFirewallとしても使用可能。

- ルールは番号の若い順(小さい)に適用される。

### Route53

- ルーティングの種類
  - シンプルルーティング
    - ランダムなルーティングでもこれを使用する。
  - 加重ルーティング
    - 複数エンドポイント毎の重みによりDNSクエリに応答。Blue/Greenデプロイメントに使用。
  - フェイルオーバールーティング
    - ヘルスチェックの結果に基づき、プライマリ・セカンダリを切り替える。高可用性が目的。
  - 複数値回答ルーティング
    - ランダムに選ばれた最大8つの別々のレコードを使用して複数の値を返答する。
    - ヘルスチェックを実施したり、ELBのようにDNSを使用した負荷分散が可能
  - レイテンシールーティング
    - レイテンシが小さいリージョンへルーティングする。
  - 位置情報ルーティング
    - ユーザーのIPアドレスにより位置情報を特定し、地域毎に異なるレコードを返す。
  - 地理的近接性ルーティング
    - ユーザーとリソース双方の場所に基づいて近接性ルールを作成してルーティングする。
    - AWSリソースを使用している場合はリソースのリージョン、それ以外の場合はリソースの緯度と経度に基づく。
    - 特殊なルーティングであり、トラフィックフローを利用して設定が必要。

- フェイルオーバールーティングを使用する場合、アクティブ・パッシブ構成となる。
  - アクティブ・アクティブにしたい場合はその他のルーティングで、ファイルオーバーを実現する。

- DDos攻撃対策
  - シャッフルシャーディングと anycast ルーティングにより、攻撃を受けていてもユーザーがアクセス可能な状態を維持することができる。

### CloudFront

- コンテンツを高速配信するためのCDNサービス。

- 画像等の取得リクエストに対して応答性を挙げるために使用。

- キャッシュ保持期間はTTL(Time To Live)で設定
  - TTLのデフォルトは1日。0秒～1年で指定可能。

- コンテンツ圧縮を有効化することで、高速化やデータ削減(コスト削減)が可能。
  - ただし、Viewer（ブラウザ等）で`Accept-Encoding: gzip`が有効である必要がある。

- 地理的ブロッキングで、特定地域のユーザーのアクセスを回避可能。

- S3へのアクセス制限(IP制限等)するをすることが可能。
  - CloudFrontのOrigin Access Identify(OAI)を使い、特定のdistributionのみをS3のBucket Policyで許可
    - OAIは特別なユーザーであり、そのユーザーに限定してBucket Policyを設定
  - CloudFrontにWAF ACLを設定し、特定のIPアドレスのみを許可

- CloudFrontそのもので、Referer制限はできない。WAFを利用する必要がある。

- アクセスユーザーの制御
  - 署名付きURLと署名付きCookieを利用することが可能。

- キャッシュを効かせるためには、`Cache-Control`の`max-age directive`を適切に大きく設定する。

- ディストリビューション
  - フェイルオーバー設定が可能。
  - オリジングループとしてプライマリ、セカンダリを作成
  - プライマリオリジンが使用できない場合、セカンダリに切り替わる。
    - プライマリでHTTPレスポンスが特定のコードを返す場合なども設定可能。

- Lamda@Edge
  - Node.jsによるLambda関数をユーザーに近いCloudFrontで実行することができる。

- HTTPS化
  - 以下のいずれかでHTTPS対応を実施できる。
  - Viewer Protocol PolicyでHTTPS Onlyを設定
  - Viewer Protocol PolicyでRedirect HTTP to HTTPSを設定
  - Viewer Protocol PolicyでSSL/TLS証明書を利用できる設定

### オンプレIP移行

- ROA(Route Origin Autorization)を利用し、特定のIPアドレスを移行することができる。

- 地域インターネットレジストリ(RIR: Regional Internet Registry)に登録。
- RDAP: Registry Data Access Protocolを利用して事故署名付きの X509 証明書を発行する。

- 参考
  - https://fluid-27.hatenablog.com/entry/2021/07/16/204216
  - https://www.nic.ad.jp/ja/basics/terms/roa.html

### IPフローティング

- Route53やELBを用いてインスタンスの障害に備えることが可能だが、IPフローティングでも実現できる。
- DNS情報の伝搬には少し時間が必要であるため、継続性が重要でダウンタイムを最小にするためには、この方式を選択する。
- ヘルスチェックにはスクリプトを作成する。

---
## Dev and Ops

### Beanstalk

- 自動的にデプロイ・スケーリングを行うサービス。
  - キャパシティのプロビジョニング
  - 負荷分散
  - Auto Scaling
  - ヘルスチェック
  - パッチ配布

- ユースケースとしては以下
  - Webアプリケーション
  - ワーカー環境
    - ただしBatch処理などは対象外。
  - Amazon ECSなどのDockerにホストされたアプリケーションも対象。

- 運用や監視にも使用することができる。

### OpsWorks

- ChefやPuppetが使用可能。
- 複雑なインフラストラクチャ管理や設定を行うサービス。
- スタックベースやレイヤーなどの構築の用途の場合はCloudFormationではなくこちらを使用する。

### CloudFormation

- 必須要素はResources。
- その他の要素
  - AWSTemplateFormatVersion: バージョンを記述
  - Description: コメントを記述。必ずAWSTemplateFormatVersionの後に記載する必要がある。
  - Metadata: テンプレートに関する追加情報
  - Parameters: 実行時に(スタックの作成・更新時に)テンプレートに渡す値。ResourcesおよびOutputsを参照可能。
  - Rules: Parameterを検証するルール
  - Mappings: 条件パラメータの指定に使用できるMap(辞書)
  - Conditions: 条件指定に使用。本番か開発かなど。
  - Transform: SAMを使用したり、別のテンプレートを利用するために使用。
  - Outputs: 構築後に出力させる値や、Exportフィールドにより他のテンプレートから参照させることなどが可能。

- 変更セット
  - スタックの更新をしたり、その影響度を確認することができるスタック

- ドリフト
  - テンプレートによる展開後に変更した場合に、差分をチェックする機能

- Export/Import
  - スタック間のリソース参照機能

- スタックセット
  - 救数のAWSアカウントやリージョンにリソースを展開できる。
  - クロスアカウントやクロスリージョンのシナリオを解決可能。

- DeletionPolicy
  - 停止後にデータを保持したい場合、DeletionPolicyを有効にする必要がある。
  - DeletionPolicyには以下の種類がある。
    - Snapshot
      - スナップショットを作成したうえで、リソースを削除する。
      - このポリシーはスナップショットが作成できるリソース(EC2やRDS)にのみ追加することができます。

    - Retain
      - リソースやコンテンツを削除せず保持します。
      - この削除ポリシーは、あらゆるリソースタイプに追加することができます。

    - Delete (Default)
      - スタックの削除時にリソースと (該当する場合) そのすべてのコンテンツを削除します。
      - この削除ポリシーは、あらゆるリソースタイプに追加することができます。

- CreationPolicy
  - ResourceSignalパラメータでTimeoutを設定することができる。
  - これによりタイムアウトを超えるまでは終了しないようになります。

### CloudWatch

- CloudWatch Logs
  - EC2, CloudTrail, Route53などのログファイルを監視することが可能
  - エラー率が閾値を超えた場合に、管理者に通知を送るなどが可能。
  - アプリケーションのログは取れないため、X-rayのエージェントが必要。

- CloudWatch Events
  - システムイベントを監視し、ルールに一致したイベントを一つ以上の関数やストリームに振り分けられる。
  - cron式やrate式により、特定の時間にトリガしたり、スケジュールが可能。

- CloudWatch エージェント
  - EC2インスタンスやオンプレミスサーバーから、メトリクスやログを収集する機能。

- CloudWatch Logs Insights
  - ログを解析・可視化するフルマネージドサービス。

- 異なるリージョンからのメトリクスを単一のCloudWatchで取得可能。

### Amazon API Gateway

- Lambdaなどの前に設置し、公開されたAPIとして利用できる。
- REST APIおよびWebSocket APIを作成可能
- 一時的な高負荷対応には、スロットリング制限設定とキャッシュを有効化を実施する。
- APIコールとデータ量に応じた費用のみが発生する。

### AWS X-Ray

- リクエストやレスポンスの追跡・監視が行える。

### AWS SAM

- サーバレスアプリケーション構築のデプロイツール。
- CloudFormationと連携し、SAMがSAM構文をCloudFormation構文に変換する。

### AWS AppSync

- DynamoDB、Lambda、HTTP APIなどのデータを組み合わせて、リアルタイムアプリケーションのGraphQLインターフェースを提供するサービス。

---
## アクセス管理

### IAM

- ポリシーの種類
  - AWS管理ポリシー
    - AWSがあらかじめ準備しているポリシー
  - カスタマー管理ポリシー
    - ユーザー(開発者)が自身でカスタマイズしたポリシー
  - インラインポリシー
    - 1つのエンティティに埋め込まれたポリシーでIAMユーザなどに適用するのは非推奨。
    - S3バケットポリシーやIAMロールの信頼ポリシーなど、リソース固有のポリシーが設定可能な場合に使用
    - 他には、SNSのTopicポリシーやVPCエンドポイントポリシーなどが該当

- リソースベースのポリシーがあるサービス一覧
  - https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/reference_aws-services-that-work-with-iam.html

- 本番・開発の分離
  - 開発者には開発者用アカウントを付与する。
  - インスタンス等にタグを設定し、操作許可を限定する設定も有用。

- サポートするIdP
  - IdPはIdentify Providerのこと。
  - IdPとSP(Service Provider)の間の認証方式がSAML2.0やOpenID Connect。
  - IAMは、OpenID Connect または SAML 2.0と互換性のあるIdPをサポートしている。
  - OpenIDの場合、ウェブIDフェデレーションを利用する。

- 外部のIdPを使う場合
  - マネコンおよびCLIを使って、IdPのエンティティを作成して、SAMLメタデータドキュメントなどをuploadする。
  - その後、IAMロールを作成し、信頼ポリシーでProviderを、信頼関係を確立するPrincipalとして設定する。
  - ロールに必要な権限を設定する。
  - オンプレミス環境のユーザー、グループをIAMロールにマッピングするアサーションを定義する。

- aliasされたログインURL
  - `https://development-group.signin.aws.amazon.com/consle/`

- Web IdP
  - Amazon, Facebook, GoogleなどのOIDC互換のIdPを使う場合、Web IdPと呼ぶ。
  - モバイル認証で、Cognitoの代わりに使用されることがある。
  - 認証には、AssumeRoleWithWebIdentity APIを使用する。

- カスタムIDブローカ
  - LDAPなどのローカル認証システムを用いてAWSのリソースにアクセスするための方法

### AWS Organizations

- 複数のAWSアカウントを管理するサービス。

- SCPでアクセス権限のコントロールを行う。ホワイトリスト形式のポリシー。

- デフォルトでは、SCPは`FullAWSAccess`が設定されているため、制限するためにはこのポリシーのデタッチが必要。

- SCPが設定がされたOU(Organization Unit)のアカウントは以下が行える。
  - ポリシー内で許可したアクションを、IAMポリシーで権限付与が実行できる。

- AWS Resource Access Manager (AWS RAM)
  - アカウント間でリソース共有を行うためにはこちらを使用する。


### AD関連

- AD Connector
  - 既存のADを使って、AWS環境へのアクセスを可能にしたり、IAMによるユーザー管理する。

- Simple AD
  - ADを作成するサービス
  - 簡易にAmazon Workspaceに認証・アクセスできる。

- AWS Managed Microsoft AD
  - フル機能のMicrosoft Active DirectoryをAWSで使用できる。
  - SAMLなどのフェデレーションしたり、オンプレとのADの連携も可能。
  - 既存のADワークロードをAWSに移行する場合は、こちらを利用する。

### AWS Service Catalog

- 組織としてのガバナンスが適用されたテンプレートを、AWS利用者であるユーザー部門に利用させることができるサービス。
- Service Catalogは、CloudFormationテンプレートを製品としてインポートする事が出来ます。
- CloudFormationテンプレートには、多くのAWSサービスの構成情報を記載できます。
- これにより、スタンプを押すように統一的な環境を作成する事が出来ます。
- 参考
  - https://dev.classmethod.jp/articles/serca/

### AWS Systems Manager

- Systems Manager Automation
  - メンテナンスやデプロイタスクを自動ワークフロー化できる。
  - 定義済みのワークフローを使うこともできる。
    - EC2インスタンスの再起動
    - AMIの作成、など

- Systems Managerコンソール
  - ワークフローの進行状況を確認できる。

- AWS Systems Manager エージェント(SSMエージェント)
  - System Managerがリソースを管理できるようにするためのエージェント。
  - EC2インスタンス、オンプレサーバーなどにインストールして使用する。
---
## Computing

### EC2

- インスタンスファミリー
  - 汎用: T,M,A
    - T: Turbo. バーストタイプ
    - M: Most scenarios. 標準的なやつ
    - A: Arm. ARMプロセッサタイプ(AWS Graviton)
    - Mac: Apple Mac Mini搭載
  - コンピューティング最適化: C
    - C: Compute. 計算パフォーマンスが高い。
  - メモリ最適化: R,X,Z
    - R: RAM. メモリ最適化
    - X: Extra large memory. 最大メモリ量が大きい
    - Z: Hz. 高クロックなコア搭載モデル。
  - 高速コンピューティング: P,G,F,Inf,etc
    - P: general Purpose. 汎用GPU搭載
    - G: Graphics. グラフィックス特化GPUタイプ
    - F: FPGA. FPGAモデル
    - Inf: Inference. 機械学習推論に最適化されたタイプ。AWSが開発した Inferentia チップが搭載。
    - Trn: Trainium. AWSが開発したML用チップ Trainium 搭載タイプ
    - DL: Deep Learning. Gaudiアクセラレータ搭載タイプ
    - VT: Video Transcoding. 最大4K解像度に対応したリアルタイムトランスコーディングが可能なタイプ(Xilinx U30 Acceralatorが搭載)
  - ストレージ最適化: I,D,H
    - I: IO Performance. NVMe SSD搭載でIO性能が高い
    - D: Dense storage. 最大48TBのHDD搭載
    - H: High disk thoughput. 高スループットタイプ。これもHDD。
  - 参考
    - https://otomosa.com/aws/post-1870/
    - https://aws.amazon.com/jp/ec2/instance-types/

- 購入方法
  - オンデマンド
  - リザーブド
  - スポット
  - オンデマンドのキャパシティ予約 + Savings Plans

- リザーブド・コンバーティブル
  - インスタンスファミリー・OS・テナンシー・支払いオプションを変更可能。
  - スタンダードでも、AZ・インスタンスサイズ・ネットワークタイプは変更できる。

- 物理専有型
  - ハードウェア専有インスタンス(Dedicated Instance)
    - 専用HWのVPCで実行されるEC2インスタンス。
    - VPC構成をする際にdedicatedというのを選ぶと選択することができる。
    - 他のAWSアカウントから分離したインスタンスとなるが、同じアカウント内では共有する可能性がある。
  - Dedicated Host
    - 同じアカウント内でも共有しない設定が可能なインスタンス形式。
    - IAMグループなどで閉じたインスタンスにすることができる。
    - 用途としては、オンプレのライセンスサーバーなどをAWSに移行したい場合など。
  - ベアメタル(Bare Metal)
    - サーバーのProcessorやMemoryにアクセス可能なインスタンス。
    - 下層のハードウェアレベルまでアクセス可能。

- ユーザーデータ
  - 起動時に実行したいコマンドを記述することができる。

- 起動設定と起動テンプレート
  - 起動設定は、AMIが変更されると再作成が必要、バージョン管理が不可など機能が少ない。
  - 起動テンプレートはバージョン管理が可能。AMIと独立して設定ができる。
    - AMIは「起動テンプレートに含めない」という設定が可能。
  - 双方とも、Auto Scalingグループに紐づけする。
  - そのAuto ScalingグループをELBに紐づけすることが可能。

- インスタンス間のネットワーク高速化
  - クラスタープレイスメントグループを設定する。
  - 拡張ネットワーキングをサポートするインスタンスタイプを選択

- プレイスメントグループ
  - プレイスメントグループは設定後に、起動するという手順となる。
  - 異なるインスタンスタイプをグループにすることはできない。
  - インスタンスを追加する場合は、一旦プレイスメントグループを停止する必要がある。
  - 種類
    - クラスタープレイスメントグループ
      - パフォーマンス向上が目的。単一AZ内でグループ化し、複数のVPC Peeringにまたがることも可能。
      - グループ内のインスタンスは、TCP/IPトラフィックのスループット上限が高くなり、インスタンス間通信の速度が向上する。
    - パーティションプレイスメントグループ
      - 耐障害性が目的。
      - 複数パーティションに分けられ、パーティション毎にラックがあり、パーティション同士はラックを共有しない。
    - スプレッドプレイスメントグループ
      - 更なる耐障害性が目的。
      - パーティションあたり1インスタンス構成となり、異なるラックにそれぞれのインスタンスを配置できるグループ。

- VM Import/Export
  - オンプレ環境の仮想マシンをAWSにインポートする機能

- store-backed / EBS-backed
  - store-backedはインスタンスストアがroot volumeのもの。
  - 停止すると、インスタンスストアのデータは自動的に削除される揮発型。

- キーペアの管理
  - AMIの複製では、キーペアはコピーされないため、既存のキーを使う場合には再度インポートが必要となる。

### ENI

- EC2インスタンスにアタッチするネットワークインターフェース。

- アタッチとして以下の種類がある。
  - コールドアタッチ
    - インスタンス起動時にアタッチする。
  - ウォームアタッチ
    - 停止中のインスタンスにアタッチする。
  - ホットアタッチ
    - runnning中のインスタンスにアタッチする。

- 複数アタッチすることで、それぞれをインターネット用、バックエンドとの通信用などに使い分けることも可能。

### ELB

- ELBのみでは、Auto Scalingは実施できないので注意する。

- スケールイン・アウトの繰り返し抑制
  - クールダウンタイマーの値を見直す。
  - デフォルト値は300秒である。
  - CloudWatchと連携して、スケールが設定されるがその際のアラーム閾値を見直す。

- スティッキーセッション
  - セッション中に同じユーザから来たリクエストを同一インスタンスで処理することが可能。

- クロスゾーン負荷分散
  - 複数のAZにまたがる分散を行うことができる。

- Connection Draining
  - 接続をオープンとしたまま、登録解除・異常なインスタンスへの送信を停止できる機能。
  - 登録解除の待ち時間として、タイムタイムアウトを設定できる(1～3600秒、デフォルト300秒)。
  - タイムアウトを過ぎると強制的に停止する。

### Lambda

- 制限
  - 一時ボリューム量(`/tmp`): 512MB
    - 2022/03/24のアップデートで、デフォルト512MB、最大10GBまでを設定可能となった(料金は必要)。
  - 同時実行数: 1000
  - 関数とレイヤーストレージ: 75GB
  - デフォルトタイムアウト: 3秒(最大実行時間は900秒(15分))

- Lambda Layer
  - Lambdaファンクション間で共通の処理をLambda Layerとして定義して参照できる。
  - 最大５つまでLaymbda Layerとすることが可能。

- ネットワーク
  - Lambdaはデフォルトではインターネット接続やAWSサービスにアクセスできる安全なVPCで関数を実行します。
  - 一方、ユーザーが指定したVPCで実行する場合は、VPCからアクセス権を付与される必要があります。
  - またこのVPCがプライベートサブネットである場合、NAT経由での返信処理が設定されていなければ、レスポンスを受け取れません。
  - 同様に、Lambdaのセキュリティグループのアウトバウンドトラフィックを設定する必要があります。

- リソースポリシーによる実行許可
  - Lambdaはリソースベースポリシーがあるため、実行の許可をこのポリシーに設定する必要がある。
  - 設定には、add-permission AWS Lambdaコマンドを使用する。
  - 参考
    - https://dev.classmethod.jp/articles/lambda-resourcebase-policy/

### Amazon ECS

- 権限付与
  - ECSにより起動するインスタンスへの権限は、ECSタスクにIAMロールを付与することにより行う。
  - 今まではEC2のIAMロールを使用する必要があった。

- 起動モード
  - EC2
    - EC2インスタンスを起動する。
  - Fargate
    - ECS・EKSで利用できる専用のコンピューティングエンジン
    - インスタンスの管理が不要(CPUやメモリなどを定義する)
    - 秒単位で数万個のコンテナ起動が可能

- トラフィック制御
  - ELBと連携して実施することができる。

- Capacity Provider Reservation
  - Auto Scalingグループを構成するために、Capacity Provider Reservationを使用する。

### Amazon EKS

- kubernetesを使用する際に使うサービス
- ECSと違う点は、kubernetesを活用した開発や管理をある程度自動化することができる部分である。

### Auto Scaling

- 簡易スケーリングポリシー
  - ターゲット追跡スケーリングポリシーの通常設定
  - アラーム設定に基づき１段階のスケーリングを実施

- ステップスケーリングポリシー
  - アラーム超過サイズに基づいて、インスタンス数を動的に調整する、複数段階のスケーリングを実施
  - これにより、段階的なウォームアップ条件を設定可能

- 手動スケーリング
  - 希望容量を手動で調整する。

- スケジュールされたスケーリング
  - 実施日時を指定する。

- スケールに24時間失敗し続けると、AUto Scalingが停止する可能性がある。

- ヘルスチェック
  - ELBとEC2どちらを利用するか設定する。

- スケーリング時のメトリクス
  - CPU使用率を使う。メモリ使用率を使ったトリガーはデフォルトで設定できない。

### AWS Application Migration Service (AWS MGN)

- オンプレの仮想マシンをAWSに移行するツール
  - VMware vSphere
  - Microsoft Hyper-V/SCVMM
  - Azure 仮想マシン

- AWS Replication Agent 
  - 移行元となるソースサーバーにインストールするエージェント
  - レプリケーション設定の表示・定義ができる。
- 旧サービスは、AWS Server Migration Service(SMS)だが、2023年3月31までで使えなくなる。

## VM Import/Export

- 仮想マシンをEC2にいこうするためのサービス
- 似た名前として AWS Import/Exportというものがあるが、ストレージ転送のサービスであり、現在は利用されないので注意する。

### AWS License Manager

- ベンダーが提供するライセンス管理を行うサービス。
- 契約条件に基づくルールを作成することで、ライセンス違反を防ぐことが可能。
- 違反する場合は、インスタンスの起動を停止したり、管理者に侵害を通知できる。

---
## Security

### AWS STS

- スイッチロールなどに使用
- またモバイルアプリケーションで一時的な認証情報を使用する際にも使用可能。
- SAML2.0をサポート
  - 異なるドメイン間でユーザー認証を行うためのXMLベースの標準規格。
  - SSOなどの要件に利用される。

### HSM

- Hardware Security Module
- 厳しいセキュリティ要件を満たすことができ、FIPS 140-2 Level 3に準拠している。
- HSMはゼロ化してキーをロスすると、コピーを有していない場合は、新しいキーは取得不可能となる。

### AWS WAF

- HTTPリクエストレベルでの制限・許可などを行う。
  - 特定のリクエスト以外を許可（攻撃を遮断）
  - 特定のリクエストのみを許可（アクセス制限：日本国内のみ）

- Referer制限
  - 直前に参照していたURLに基づいて制限を行う。

### Amazon Inspector

- セキュリティ評価を自動で実施するサービス
- アプリケーションに対して、脆弱性やべくとプラクティスからの逸脱がないかなどを自動で評価できます。

### AWS CloudTrail

- アカウントのガバナンス、コンプライアンス、運用監査、リスク監査を行うサービス。

### AWS Certificate Manager (ACM)

- SSL証明書を集中管理するためのサービス。
- ELBなどと組み合わせてよく出題される。
- CloudFrontに設定することも可能。

### AWS Shield

- DDoS攻撃を緩和するサービス。

- Standardでは、リアルタイム通知や可視化機能が提供されない。その場合はAdvancedとする必要がある。

### AWS Secrets Manager

- セキュアな資格情報を保持するために使用するサービス。

### AWS Config

- リソースの変更管理が可能

- リソースの設定変更の継続的なモニタリングが可能でコンプライアンス評価が可能。

- AWS Organizationsにおける複数アカウントについてもコンプライアンス管理が可能。

- サードパーティのリソース管理なども含まれる。

- 参考
  - https://www.yume-tec.co.jp/column/series/aws%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%8B%E3%82%A2%E3%82%92%E6%8E%A1%E7%94%A8%E3%81%97%E3%81%9F%E3%81%84%E4%BA%BA%E4%BA%8B%E6%8B%85%E5%BD%93%E5%90%91%E3%81%91%E3%81%AEaws%E5%85%A5%E9%96%80/4621

---
## Messages

### Amazon SQS

- 制限
  - キューの保持期間はデフォルト4日間。最大で14日(2週間)。
  - 保存できるメッセージの最大数は無制限
  - メッセージのサイズは256KB。
    - 拡張クライアントライブラリを使うと2GBまで可能。

- キューの削除
  - キューは明示的に削除しない限り、残り続ける。
  - また可視性タイムアウトが設定されている場合は、有効期限が過ぎれば別のインスタンスでキューが処理される。
  - 失敗し続けた場合は、デッドキューに移動する設定を行うことができる。

- Auto Scaling
  - キューの深さに応じてEC2などのリソースをスケールアウトすることが可能。

### Amazon SNS

- push型の通知サービス
- リソース間のイベント通知、モバイルへのプッシュ通知などが用途となる。
- SNSからSQS, SES, Lambdaへの通知も行う用途で使用する。

### Amazon SES

- マネージドなメールサービス
- イベントに応じてメール配信をする際は、SNS -> SESという形で構築する。

### Amazon MQ

- 業界標準のメッセージングAPIとブローカを提供するサービス。

---
## Workflow

### AWS Step Functions

- サーバレスのオーケストレーションサービス
- Lambda関数などのAWSリソースを組み込んだり、人手によるアクションをタスクに組み込むことができる。
- JSON形式でステートマシンを定義する。
- 最長１年間実行可能。
- プロセスに親子関係がある場合は、SWFを選択する。(Step FUnctionsで対応できない)

### Amazon SWF

- 旧型のワークフローシステム。
- 利用が水使用されていないため、ほぼ正解の選択肢にはならない(Step Functionsがない場合は選択肢になるかも)
- プロセスに親子関係がある場合は、SWFを選択する。(Step FUnctionsで対応できない)

---
## IoT

### AWS IoT Core

- インターネット接続されたデバイスから、クラウドやその他のデバイスに簡単かつ安全に通信するためのマネージド型サービス。
- センサーデバイスを利用した車両管理アプリケーションを容易に構築することが可能。
- 数十億個のデバイスと数兆件のメッセージをサポート。

---
## ML

### Amazon Macie

- S3内の機密データを検出・分類・保護できるフルマネージド型サービス
